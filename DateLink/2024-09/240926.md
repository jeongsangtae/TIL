# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 백엔드 배포 환경의 환경 변수에 액세스 토큰 키, 리프레쉬 토큰 키 내용 추가
    - 배포한 사이트에서 로그인을 시도하면, `secretOrPrivateKey` 관련 오류가 발생
      - 로컬 환경에서만 .env 파일을 통해서 환경 변수로 액세스 토큰과 리프레쉬 토큰 키를 구성하고 사용했기 때문에, 배포 환경의 환경 변수에서도 토큰 키를 사용할 수 있도록 추가
    - 토큰 키를 추가하고 다시 로그인한 결과, 토큰 키가 쿠키에 저장되지 않고 로그인이 되는 것을 확인
      - 쿠키에 토큰이 저장되지 않는 오류를 찾아보니, 쿠키에 토큰을 저장할 수 있는 설정을 로컬 환경에서만 저장할 수 있도록 구성해놓은 상태라서 이에 대한 설정을 변경해줘야 함
      - secure, httpOnly, sameSite에 대한 설정을 올바르게 구성해줘야 배포한 사이트에서도 쿠키를 안전하게 주고 받고 브라우저에서 사용할 수 있음

  <br />

  - 백엔드에서 JWT 토큰 쿠키 내용에 동적 구성 추가 (secure, sameSite)
    - 새로운 환경 변수 추가
      - .env 파일에서 새로운 환경 변수인 `NODE_ENV` 내용을 추가
        - 로컬 환경의 `NODE_ENV`에서는 "development" 내용이 들어가도록 구성
        - 배포 환경의 `NODE_ENV`에서는 "production" 내용이 들어가도록 구성
    - user-routes, jwt-auth
      - isProduction 변수에 새롭게 추가한 환경 변수인 `NODE_ENV`를 "production"와 비교해서 일치하면 true, 불일치하면 false가 들어가도록 구성
      - 쿠키 내용에서 secure 내용에 isProduction 변수 내용이 들어가도록 구성
        - 배포 환경의 환경 변수 내용이 확인되면 true, 로컬 환경의 환경 변수 내용이 확인되면 false
      - 쿠키 내용에서 sameSite 내용에 isProduction 변수를 확인해서 조건부로 내용이 들어가도록 구성
        - true일 경우, "None" 내용이 들어가도록 구성
        - false일 경우, "Lax" 내용이 들어가도록 구성
      - user-routes 라우터에서는 내용이 정상적으로 넘어오고 출력되는 지 확인하기 위해서 console.log를 추가
        - 환경 변수인 NODE_ENV와 변수 isProduction를 확인
    - 쿠키 설정
      - secure
        - true 일 때
          - HTTPS 프로토콜을 통해서만 쿠키가 전송되도록 보안 조치를 설정
          - HTTP 요청에서는 쿠키가 전송되지 않으며, HTTPS 연결에서만 쿠키를 주고 받음
          - 배포 환경이 HTTPS인 경우, 이 설정이 없으면 쿠키가 아예 전송되지 않음
          - 배포 환경에서 HTTPS를 사용하는 경우에는 이 설정을 반드시 사용하는 것이 좋음
          - 이 설정으로 쿠키가 암호화된 연결을 통해 안전하게 전송됨
          - 보안이 중요한 인증 토큰(JWT), 세션 등의 쿠키를 안전하게 보호할 수 있음
        - false 일 때
          - HTTP 및 HTTPS 모두에서 쿠키가 전송됨
          - 보안이 설정되지 않은 HTTP 프로토콜을 사용하는 요청에서도 쿠키가 전송될 수 있음
          - 로컬 개발 환경이나 보안이 크게 중요하지 않은 환경에서는 이 설정을 사용 가능
          - 보안 측면 조금 취약함
          - HTTP
        - false로 설정되었으나, 왜 HTTPS 연결에서 쿠키가 전송되지 않는가 ?
          - 이론적으로는 HTTP와 HTTPS에서 모두 전송될 수 있지만, 실제 배포 환경에서의 동작은 다르다.
          - 현대 브라우저들은 보안 강화를 위해 HTTPS 환경에서 false로 설정된 쿠키의 전송을 자동으로 차단하는 경우가 많음
            - HTTPS 연결에서는 쿠키의 보안을 보장하기 위해 true로 설정된 쿠키만 전송하려고 함
          - false로 구성되었을 때는 HTTP에만 적합하며, HTTPS에서 사용할 경우 보안적으로 안전하지 않기 때문에 브라우저에서 이를 차단함
          - 결론은 브라우저에서 false로 설정되면, 보안이 취약하다고 판단하고 사전에 차단해서 HTTPS 연결에서 쿠키가 전송되지 않도록 해줌
        - 로컬 환경에서 개발할 때는 false로 설정하여 HTTPS가 필요 없이 쿠키를 전송하도록 설정할 수 있고, 배포 환경에서 HTTPS를 사용 중이라면 true로 설정하여 보안을 강화해야 한다.
          - HTTP에서는 쿠키가 전송되지만, HTTPS에서는 브라우저가 보안상의 이유로 차단할 수 있음
          - 배포 환경이 HTTPS일 경우, 반드시 true로 설정해야 쿠키가 HTTPS 연결을 통해 전송됨
      - httpOnly
        - 쿠키를 클라이언트 측 JS에서 접근하지 못하게 보호하는 기능을 제공
        - true일 때
          - 쿠키가 오직 서버에서만 접근할 수 있도록 설정
          - 브라우저의 JS 코드로는 해당 쿠키에 접근할 수 없기 때문에, XSS 공격으로부터 쿠키를 보호할 수 있음
          - 주로, 액세스 토큰이나 세션 쿠키와 같은 민감한 정보를 보호하기 위해 사용
          - 보안 강화
        - false일 때
          - 쿠키가 JS에서 접근 가능함
          - ex) document.cookie로 쿠키를 읽거나 수정할 수 있음
          - 그러나, 위 같이 하면 XSS 공격에 취약해지기 때문에 민감한 정보를 저장할 때는 추천되지 않음
          - 보안 취약
        - true로 설정하는 것이 특히 인증 정보를 안전하게 유지하는데 필수적인 보안 조치임
      - sameSite
        - 프론트엔드와 백엔드가 서로 다른 도메인에 있을 경우, "None" 설정을 추가해야 함
          - 해당 설정을 통해 쿠키가 서로 다른 도메인 간에도 주고받을 수 있게 됨
        - "None"일 경우, 서로 다른 도메인 간 요청을 허용하는 쿠키 정책으로 프론트엔드와 백엔드가 동일한 도메인이 아니라면 "None" 옵션이 필요함
          - "None" 옵션으로 구성하지 않으면 브라우저가 보안 정책에 의해 쿠키를 차단할 수 있음
        - 동일한 도메인에서만 동작한다면 "strict"나 "lax"도 가능
          - 하지만, 대부분의 배포 환경에서는 프론트엔드와 백엔드가 다른 도메인에 있을 가능성이 높아서 "None"이 적합함
        - 로컬 환경에서도 프론트엔드와 백엔드가 다른 포트를 사용하면 "None"으로 설정해야 쿠키가 프론트엔드에서 제대로 전송되고, 백엔드에서도 처리됨
        - sameSite가 설정되지 않은 경우, 기본값은 "lax"
          - 명시적으로 설정하지 않으면 기본값은 "lax"이며, "None"은 자동으로 적용되지 않는다.
        - 로컬 환경에서 sameSite 속성을 명시하지 않고도 정상적으로 작동한 이유는 브라우저의 기본 동작 때문임
          - 로컬 환경에서는 "localhost"가 동일한 출처로 간주되기 때문에, 포트가 다르더라도 대부분의 브라우저에서는 이 요청을 안전하다고 판단하고 쿠키 전송을 허용함
          - 개발 중에 사용되는 "localhost"는 대부분의 브라우저에서 특별한 취급을 받기 때문에 sameSite 속성이 없는 경우에도 쿠키가 정상적으로 작동할 수 있음
        - 배포 환경에서는 CORS 및 보안 정책이 엄격하게 적용되므로, 쿠키가 제대로 전달되도록 sameSite 설정을 명시적으로 정의해야 함
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/5e5c2de0bc4190d2f488fcae2e557409f64dd423)

  <br />

  - 프론트엔드에서 API URL 동적 구성 추가 (채팅)
    - Chats
      - apiURL 변수 내용을 추가해주고, 저장된 메시지를 불러오는 함수, WebSocket 연결과 관련된 내용, 메시지를 전달하는 함수에 구성된 fetch 함수 내의 API 경로에서 사용될 수 있도록 구성
    - 오류 해결
      - 사용자 로그인을 한 후에, socket.io 관련 오류가 콘솔에서 확인되기 때문에 해당 문제를 해결해주기 위해서, 저장된 메시지를 불러오는 fetch 함수, socket.io와 연결하고 실시간 메시지를 수신하는 내용, 메시지를 저장하는 fetch 함수에서 apiURL 변수를 사용해서 API 경로가 동적으로 구성될 수 있도록 해주었다.
      - 채팅 관련 내용에서 API 경로를 동적으로 구성해줌으로써 에러가 사라지고, 문제없이 채팅 관련 내용이 보여지는 것을 확인
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/f024df6ba33e57e89611419dccf1a06aa33ec4ab)

  <br />

  - 프론트엔드에서 API URL 동적 구성 추가 (게시글 추가, 수정, 조회 수 증가)
    - Post, PostForm
      - apiURL 변수 내용을 추가해주고, fetch 함수 내의 API 경로에서 사용될 수 있도록 구성
    - 오류 해결
      - 게시글을 추가하는 기능이 작동하지 않아서, 게시글 추가 fetch 함수에 API 경로를 동적으로 구성해주면서, 수정 그리고 조회 수 증가에서도 API 경로가 동적으로 사용될 수 있도록 구성
        - 게시글 추가와 수정은 하나의 fetch 함수를 통해서 작동되는데, 이 때 들어오는 method에 의해서 API 경로가 달라지기 때문에, method에 의해 동적으로 변화하는 url 변수에 apiURL을 사용해서 동적 API 경로가 달라질 수 있도록 구성
      - 게시글 추가와 수정을 테스트해본 결과, 문제없이 추가되고 내용이 수정되는 것을 확인했고, 삭제 기능 또한 정상적으로 작동되는 것을 확인
      - 조회 수 증가 내용에서도 API 경로가 동적으로 구성되도록 해줌으로써, 게시글 클릭 시 조회 수가 증가되는 것을 확인
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/022d365cf0cc0a15a9e154a6973835e4d1bae547)

<br />

- 추가 및 해결 해야 할 내용
  - 마지막 기능 추가로, 관리자 권한을 부여하는 내용을 생각하고 있음
    - 가입할 때는 일반 사용자로 가입을 할 수 있고, admin 관리자 계정으로 관리자 페이지에서 관리자 권한을 부여하는 내용을 생각 중
  - 새롭게 발견한 문제
    - 관리자 채팅의 사용자 리스트에서 사용자와 나눈 마지막 메시지 내용을 가져오는데, 이 때 새로고침을 하지 않으면 당장 채팅을 나눠도 실시간으로 마지막 메시지가 갱신되지 않아서 새로운 메시지가 있는 지 확인할 수 없기 때문에 추가하는 것도 고려해야 함
    - 한편으로는, 관리자 채팅이라서 사용자가 겪는 불편함이 아니기 때문에 그냥 놔두는 것도 고려 중
  - 배포한 사이트 확인
    - 데스크탑 환경
      - 로그인하고 로그아웃하면 쿠키에 저장된 토큰이 사라져야 하지만, 사라지지 않으므로 확인 필요
    - 모바일 환경
      - 라이트 모드일 때 회원가입과 로그인 버튼 뒤의 배경색이 조금 다르게 구성되어 있음
      - 테마 모드 변경 버튼 위치가 어긋나 있기 때문에 수정 필요
      - 게시글 세부 페이지에서 사용자 이름, 작성 날짜, 조회 수 사이에 점 크기를 조절해야 함

# 오늘 느낀 점

- 로그인했을 때 액세스 토큰과 리프레쉬 토큰 정보가 쿠키에 저장되는 것을 확인할 수 있었고, 채팅을 입력했을 때 저장되는 것도 확인했고, 게시글 추가 및 수정, 삭제 기능이 정상적으로 작동하는 것도 확인해주었다. 추가로 테스트해본 결과, 로그인하고 로그아웃을 하면 토큰이 쿠키에서 삭제되도록 구성을 해줬으나, 현재 로그아웃을 해도 토큰이 쿠키에서 삭제되지 않기 때문에 이 부분은 다시 확인을 해줘야 하고, 모바일 환경에서는 라이트 모드일 때 드롭다운 메뉴 버튼의 배경색이 조금 다른 것을 확인했고, 테마 모드 변경 버튼 위치가 조금 어긋나 있어서 이 부분을 수정해줘야 한다. 그리고 게시글 세부 페이지에서 사용자 이름, 작성 날짜, 조회 수 사이에 구성된 점 크기가 너무 커서 이 내용 또한 수정해줘야 한다. 이제 댓글과 답글 fetch 함수 API 경로를 수정해주고, 관리자 페이지에서 구성된 fetch 함수 API 경로도 수정해주면 얼추 마무리 되기 때문에, 빠르게 수정해주고 전체적으로 기능을 테스트해서 문제가 있는 부분을 확인해주면 될 것 같다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
