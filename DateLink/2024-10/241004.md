# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 로컬 스토리지 에러를 고치기 위한 테스트 (useEffect 로직 수정)
    - 프론트엔드
      - auth-context
        - 로그인 여부에 따라 사용자 인증 및 토큰 갱신을 하는 useEffect 내부의 로직을 수정
        - 로그인 여부를 확인하는 함수 내부에 구성된 checkTokenExpiration 함수 내용을 최상단으로 옮겨서 useEffect 실행 시에 제일 먼저 실행되도록 구성
        - checkTokenExpiration 함수가 먼저 실행되며 토큰 만료 시간을 확인하는 if문이 실행되도록 구성
          - 토큰이 유효하면 로그인 유지, 토큰이 만료되어서 없다면 로그아웃되도록 구성
        - 로그인 여부를 확인하는 if문에서 verifyUser 함수를 실행하고 인터벌 내용이 작동하도록 구성
        - checkTokenExpiration 함수를 먼저 위에서 실행시켜서 토큰 만료 여부를 확인하고, 그 다음 로그인 여부를 확인하도록 수정
    - 재배포 후 확인
      - 코드 로직대로면 문제없이 작동해야 하지만, 토큰 만료 시간이 지난 후에 확인해보니 로그아웃이 되어 있지 않은 것을 확인
      - 중간에 액세스 토큰이 갱신되지 않아서 쿠키에 토큰이 삭제되어있고, 리프레쉬 토큰 만료 시간이 로컬 스토리지에 남아있는 경우에는 새로고침했을 때 다시 토큰이 생성되어 있는 것을 확인했던 것 같은데, 이게 바로 적용되지 않고 좀 나중에 적용되어서 오류였는 지, 정상 작동인 지 조금 헷갈리는데 무료 서버와 백엔드로 인해서 바로 적용되지 않았던 것 같아서 추가 확인이 필요함
      - 배포하고 바로 확인해서 잠깐 오류일 수도 있는데, 토큰 만료 시간을 대폭 줄여서 다시 확인해봐야 함
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/6beb26ee655d6b92786fb31a6cf10ebfc1cfa3dd)

  <br />

  - 로컬 스토리지 에러를 고치기 위한 테스트 (만료 시간 수정)
    - 백엔드
      - jwt-auth
        - 액세스 토큰 만료 시간을 2분으로 수정
      - user-routes
        - 액세스 토큰 만료 시간을 2분으로 수정
        - 리프레쉬 토큰 만료 시간을 10분으로 수정
    - 프론트엔드
      - auth-context
        - 액세스 토큰 유효 시간을 2분으로 수정
        - 인터벌 시간을 1분으로 수정
        - 콘솔에서 액세스 토큰과 리프레쉬 토큰 만료 시간을 정확한 시간으로 보여주도록 수정
        - 브라우저 로드 시 토큰을 확인하는 함수 추가
          - 로컬 스토리지에 저장된 isLoggedIn 내용을 확인해서 존재 할 때, checkTokenExpiration 함수가 실행될 수 있도록 구성
    - 재배포 후 확인
      - 만료 시간을 대폭 줄여서 확인해보니, 리프레쉬 토큰이 유효한 동안에 브라우저를 닫고 다시 접속하면 쿠키에 저장된 내용이 삭제되었어도 새로고침하면 새로운 토큰이 발급되어서 사용자 정보가 보여지는 것을 확인했고, 리프레쉬 토큰이 없다면 바로 브라우저를 다시 접속해도 로그인되어 있지 않고 로그아웃 되어 있는 것을 확인
      - 결국 내 생각대로 동작하는 것을 확인했는데, 리프레쉬 토큰 유효 여부에 따라서 유효하면 브라우저를 다시 접속해서 새로고침해주면 새로운 토큰이 발급되어서 사용자가 다시 사용할 수 있고, 유효하지 않다면 브라우저를 다시 접속해도 로그인되어 있지 않고 로그아웃되는 것을 확인
      - 토큰 만료 시간을 대폭 축소해서 테스트했을 때는 생각한대로 동작이 이루어짐
        - 로컬 환경과 배포 환경 모두에서 정상 동작함
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/b28fd3c980b43b110cfdde4efe189c1b12784e2e)

  <br />

  - 로컬 스토리지 에러 테스트 (토큰 재생성 시간 체크)
    - 백엔드
      - jwt-auth
        - 액세스 토큰 만료 시간을 30분으로 수정
      - user-routes
        - 액세스 토큰 만료 시간을 30분으로 수정
        - 리프레쉬 토큰 만료 시간을 2시간으로 수정
    - 프론트엔드
      - auth-context
        - 액세스 토큰 유효 시간을 30분으로 수정
        - 인터벌 시간을 15분으로 수정
    - 재배포 후 확인
      - 토큰 만료 시간과 인터벌 시간을 원래대로 되돌리고 테스트한 결과는 좀 더 시간이 지난 후에 확인을 해봐야 할 것 같음
      - 일단 브라우저를 닫았을 때, 쿠키에서 토큰이 사라진 것은 확인되었고 그 이후에 바로 새로고침을 하면 토큰이 갱신되어서 사용자 정보가 보여지는 것이 아닌 좀 브라우저를 켜놓고 나중에 갱신되는 것을 확인
        - 이 부분에서 조금 이상한게, 분명히 콘솔에서 토큰 만료 여부를 확인하는 if문이 true로 나오는 것을 확인했는데, 몇 번을 새로고침해도 바로 쿠키에 토큰이 추가되지 않고 좀 뒤늦게 추가되어서 사용자 정보가 보여지는 것을 확인했는데, 이 부분에 대한 확인은 좀 더 테스트해봐야 할 것 같음
      - 리프레쉬 토큰이 만료된 후에 어떻게 되는 지는 아직 확인해보지 못함
    - [코드 내용 ](https://github.com/jeongsangtae/mini-community-platform/commit/d74abd60f821cac64e96568f68b440508dceb936)

<br />

- 추가 및 해결 해야 할 내용
  - 마지막 기능 추가로, 관리자 권한을 부여하는 내용을 생각하고 있음
    - 가입할 때는 일반 사용자로 가입을 할 수 있고, admin 관리자 계정으로 관리자 페이지에서 관리자 권한을 부여하는 내용을 생각 중
  - 새롭게 발견한 문제
    - 관리자 채팅의 사용자 리스트에서 사용자와 나눈 마지막 메시지 내용을 가져오는데, 이 때 새로고침을 하지 않으면 당장 채팅을 나눠도 실시간으로 마지막 메시지가 갱신되지 않아서 새로운 메시지가 있는 지 확인할 수 없기 때문에 추가하는 것도 고려해야 함
    - 한편으로는, 관리자 채팅이라서 사용자가 겪는 불편함이 아니기 때문에 그냥 놔두는 것도 고려 중
  - 배포한 사이트 확인
    - 추가 오류
      - 배포한 사이트에서 로그인하고 일정 시간이 지난 후에 자동으로 로그아웃 되면서 쿠키에 저장된 데이터는 삭제되지만, 로컬 스토리지에 저장된 데이터는 삭제되지 않는 문제가 발생해서 이 부분에 대한 수정이 필요
        - 이 문제는 일단 코드는 정상 작동하지만, 무료 서버와 백엔드로 인해서 발생하는 것으로 확인
        - 추가 확인을 위해서 토큰 만료 시간을 대폭 줄여서 다시 테스트 진행해봐야 함
        - 내용을 다시 확인해보니, 무료 서버와 백엔드의 문제가 아닌 브라우저가 꺼진 상태에서는 useEffect가 작동하지 않아서 발생하는 오류이기 때문에 다시 브라우저를 켰을 때 토큰 만료 시간을 확인해서 로그인이 유지되거나 로그아웃되도록 구성을 변경해줘야 함
        - 다른 방법으로, 토큰 유효 시간을 확인하는 if문에서 true가 될 경우, refreshTokenHandler 함수가 아닌, verifyUser 함수가 작동되는 것을 어떨 지 생각해봐야 함
        - 또 다른 방법으로, 차라리 토큰 유효 시간을 액세스 토큰과 리프레쉬 토큰 둘 다 길게 지정하고 인터벌 또한 자주 발생하지 않도록 하는 것도 고려를 해봐야 함
        - 자주 갱신하지 않고 유효 시간을 길게 지정하면 굳이 사용자 정보가 쿠키에서 사라지는 불편함을 겪지 않아도 되기에 고려해봐야 함
    - UI를 수정해주고 최종 확인이 필요함

# 오늘 느낀 점

- 토큰 유효 시간을 대폭 줄인 상태에서 테스트했을 때는 분명히 문제없이 내가 생각한대로 로컬 스토리지가 초기화되는 것을 확인했고, 리프레쉬 토큰이 유효하고 쿠키에 토큰이 없는 경우에는 새로고침으로 새로운 토큰을 발급받아서 쿠키에 저장되는 것도 확인할 수 있었다. 하지만 토큰 유효 시간을 다시 원래대로 되돌리고 테스트했을 때는 리프레쉬 토큰 유효 시간이 남았음에도 새로운 토큰이 발급되어서 쿠키에 저장되지 않고, 사용자 정보가 보여지지 않아서 추가로 확인이 좀 필요하다. 만약 이 방법으로 제대로 해결이 안된다면 토큰 유효 시간을 대폭 늘려서 저런 불필요한 문제가 생기지 않도록 하는 것도 생각중이고, 또 다른 방법으로 if문 로직에서 실행되는 함수를 변경해서 액세스 토큰이 문제없이 갱신되는 지 확인해볼 생각이다. 로컬 스토리지 초기화 오류를 빠르게 해결하고 싶었는데, 생각보다 너무 질질 끌리는 것 같아서 생각한 내용 몇 가지를 더 테스트해보고 안된다면 그냥 토큰 유효 시간을 길게 구성해서 불필요한 오류가 없도록 해줄 생각이다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
