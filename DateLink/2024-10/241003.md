# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 로컬 스토리지 에러 테스트 (토큰 재생성 시간 체크)
    - 프론트엔드
      - auth-context
        - 인터벌이 정상적으로 작동하는 지 확인할 수 있도록 현재 시간을 콘솔에서 출력하도록 구성 추가
    - 재배포 후 확인
      - 15분 간격으로 인터벌이 작동되어, 정확히 15분 간격으로 콘솔에 현재 시간이 출력되는 것을 확인
      - 인터벌이 작동되면서 if문 로직이 실행되고, 토큰이 유효한 지 확인하고 새롭게 갱신되는 것을 확인
      - 브라우저가 열린 상태에서 2시간이 지난 후에 리프레쉬 토큰이 만료되면서 자동으로 로그아웃 되는 것을 확인
      - 브라우저가 닫힌 상태에서 2시간이 지난 후에 로그인이 되어 있으며 여전히 쿠키만 초기화되고, 로컬 스토리지는 초기화되지 않는 것을 확인
      - 만료 시간을 축소한다고 해결될 문제가 아님을 파악, 다시 내용을 확인해서 근본적인 원인을 찾아야 함
    - [코드 내용 1](https://github.com/jeongsangtae/mini-community-platform/commit/03d279062c0a45e042a7cc100c983c83c766463d)
    - [코드 내용 2](https://github.com/jeongsangtae/mini-community-platform/commit/2ebc88cc6539551d367b16b7f28fd9a1e14ddaab)

  <br />

  - 로컬 스토리지 초기화 오류 문제
    - 문제 파악
      - 브라우저가 열린 상태에서 테스트를 해본 결과, 만료 시간이 지나면 문제없이 로컬 스토리지와 쿠키가 초기화 되는 것을 확인
      - 브라우저가 닫힌 상태에서 만료 시간이 지나면 로컬 스토리지는 초기화되지 않고, 쿠키만 초기화 되는 것을 확인
      - 만료 시간을 짧게 수정하고 테스트해도 동일하게 브라우저가 닫힌 상태에서는 로컬 스토리지가 초기화되지 않는 것을 확인
      - 브라우저가 닫혔을 때도 리프레쉬 토큰이 만료되면 로컬 스토리지가 초기화되도록 해줘야 함
    - 원인 추측
      - 브라우저를 닫고 만료 시간이 지나도 로컬 스토리지가 초기화되지 않는 이유는 로컬 스토리지의 특성 때문일 수 있다고 생각
      - 로컬 스토리지는 기본적으로 브라우저 탭이나 창을 닫아도 사라지지 않고 지속적으로 저장된 데이터를 유지함
      - 반면 쿠키는 만료 시간이 지나면 자동으로 삭제되지만, 로컬 스토리지는 브라우저를 닫거나 열어도 남아 있는 것이 정상적인 동작임
      - 무료 서버나 백엔드를 사용하고 있는 것이 문제가 될 수 있음
        - 중간에 일시 정지되거나 중단되는 문제 때문일 수 있다고 생각
    - 실제 원인
      - 브라우저를 닫은 상태에서는 useEffect가 작동하지 않음
        - useEffect는 컴포넌트가 마운트되거나 상태가 변경될 때 실행되는 React 훅이기 때문에, 브라우저가 꺼지면 React 앱 자체가 실행되지 않으므로 이 useEffect 내의 코드가 작동하지 않음
        - 이로 인해, 브라우저가 꺼진 상태에서는 만료 시간을 체크하거나 로그아웃 작업을 처리할 수 없음
        - 브라우저가 다시 켜지면 해당 useEffect가 다시 실행되고, 그 때 만료 시간에 따라 로그아웃 처리가 될 수 있음
      - 브라우저가 닫힌 상태에서는 로컬 스토리지는 유지되기 때문에, 만료 시간이 지났어도 그대로 남아 있을 수 있음
        - 로컬 스토리지는 브라우저를 닫는다고 해서 자동으로 사라지지 않음
      - 쿠키와 로컬 스토리지 차이
        - 쿠키는 서버나 클라이언트에서 만료 시간 설정이 가능하며, 만료 시간이 지나면 자동으로 삭제되도록 설정할 수 있음
        - 그러나 로컬 스토리지는 자동 삭제가 이루어지지 않고, 명시적으로 삭제해줘야 함
        - 이러한 차이 때문에 쿠키는 만료 시간이 지나면 삭제되는데 로컬 스토리지는 유지되는 상황이 발생할 수 있음
        - 쿠키의 만료 처리는 브라우저 자체에서 처리해주지만, 로컬 스토리지는 JS로 직접 처리해야 함
      - 원인 정리
        - 문제 원인 1
          - 로컬 스토리지 자체는 브라우저가 꺼져도 데이터가 남아 있고, useEffect는 브라우저가 꺼지면 실행되지 않기 때문에 토큰의 만료 시간이 지나면 쿠키만 초기화 됨
        - 문제 원인 2
          - 무료 서버나 백엔드는 해당 문제와 관련 없음
          - 클라이언트 측 로컬 스토리지는 브라우저 내부의 JS로 처리되기 때문에, 서버가 유료인지 무료인지는 영향을 주지 않음
      - 현재 구성된 코드 로직과 예상 대책
        - 브라우저가 열려 있는 동안에만 인터벌이 작동해서 주기적으로 토큰 만료 시간을 확인하기 때문에, 이 방식은 브라우저가 켜져 있을 때는 정상적으로 만료 시간을 체크하고, 만료되면 로그아웃 함수를 호출해서 초기화 해주기 때문에 정상적으로 작동함
        - 하지만, 브라우저가 닫힌 상태에서는 해당 로직이 실행되지 않기 때문에 브라우저가 꺼진 상태에서 만료 시간이 지나도 로그아웃 처리가 되지 않고 로컬 스토리지에 데이터가 남아 있을 수 있기에 이에 대한 처리가 필요함
    - 해결 방안
      - 현재 useEffect에서 로그인 상태를 기준으로 인증 및 토큰 만료 시간을 체크하고 있지만, 이 코드로는 브라우저가 다시 열렸을 때 토큰 만료 시간을 바로 체크하지 못하기 때문에 수정이 필요
      - 브라우저가 다시 열렸을 때 useEffect가 작동해서 토큰 만료 시간을 체크하는 로직이 필요
      - 로그인 상태를 확인하는 코드를 나중에 실행되도록 해주고, 먼저 컴포넌트가 마운트되면 바로 만료 시간을 확인해서 그에 따라서 로그인을 유지하거나 로그아웃이 되도록 해줘야 한다.
    - 정리
      - 브라우저가 꺼진 상태에서는 useEffect가 실행되지 않기 때문에 만료 시간을 체크할 수 없으므로, 다시 브라우저가 열렸을 때 바로 만료 시간을 체크하고, 만료되었으면 자동으로 로그아웃하는 로직이 필요

<br />

- 추가 및 해결 해야 할 내용
  - 마지막 기능 추가로, 관리자 권한을 부여하는 내용을 생각하고 있음
    - 가입할 때는 일반 사용자로 가입을 할 수 있고, admin 관리자 계정으로 관리자 페이지에서 관리자 권한을 부여하는 내용을 생각 중
  - 새롭게 발견한 문제
    - 관리자 채팅의 사용자 리스트에서 사용자와 나눈 마지막 메시지 내용을 가져오는데, 이 때 새로고침을 하지 않으면 당장 채팅을 나눠도 실시간으로 마지막 메시지가 갱신되지 않아서 새로운 메시지가 있는 지 확인할 수 없기 때문에 추가하는 것도 고려해야 함
    - 한편으로는, 관리자 채팅이라서 사용자가 겪는 불편함이 아니기 때문에 그냥 놔두는 것도 고려 중
  - 배포한 사이트 확인
    - 추가 오류
      - 배포한 사이트에서 로그인하고 일정 시간이 지난 후에 자동으로 로그아웃 되면서 쿠키에 저장된 데이터는 삭제되지만, 로컬 스토리지에 저장된 데이터는 삭제되지 않는 문제가 발생해서 이 부분에 대한 수정이 필요
        - 이 문제는 일단 코드는 정상 작동하지만, 무료 서버와 백엔드로 인해서 발생하는 것으로 확인
        - 추가 확인을 위해서 토큰 만료 시간을 대폭 줄여서 다시 테스트 진행해봐야 함
        - 내용을 다시 확인해보니, 무료 서버와 백엔드의 문제가 아닌 브라우저가 꺼진 상태에서는 useEffect가 작동하지 않아서 발생하는 오류이기 때문에 다시 브라우저를 켰을 때 토큰 만료 시간을 확인해서 로그인이 유지되거나 로그아웃되도록 구성을 변경해줘야 함
    - UI를 수정해주고 최종 확인이 필요함

# 오늘 느낀 점

- 로컬 스토리지가 토큰 만료 시에 초기화되지 않고 남아있는 이유는 무료 서버나 백엔드 때문이 아닌, 브라우저를 닫게 되면 useEffect가 작동하지 않게 되면서 토큰 만료 시간이 지난 후에 쿠키에 저장된 토큰만 삭제되고 로컬 스토리지가 초기화되지 않는 것이었다. 그리고 브라우저에 다시 접속했을 때 해당 useEffect가 바로 실행되지만, 토큰이 만료되어 토큰 인증 단계에서 오류가 생기기 때문에 해당 코드 로직을 수정해서, 먼저 브라우저에 접속했을 때 바로 토큰 만료 시간을 확인하고 만약 이미 지났다면 로그아웃, 아니라면 로그인을 유지하는 방향으로 수정해서 테스트해봐야 한다. 추가로 토큰이 존재하는 것을 확인한 후에 로그인이 유지된 상태로 인터벌 내용이 정상적으로 작동하는 지도 함께 확인을 해봐야 한다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
