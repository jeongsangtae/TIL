# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 로컬 스토리지 에러를 고치기 위한 해결책 테스트 (토큰 갱신중 로딩 추가)
    - 프론트엔드
      - auth-context
        - 토큰 갱신 관련 useEffect 내의 if문에서 초기에 갱신 관련 로딩 상태를 구성하고, 토큰이 갱신되면 해제되도록 try-catch 문을 추가
        - 테마 모드 관련 내용 삭제
          - 주석 처리하고 사용하지 않던 코드
        - JSX 코드 부분에서 isRefreshing를 확인하고 true일 때는 다른 컴포넌트가 렌더링되고, 문제없이 갱신되면 children prop이 사용될 수 있도록 구성
      - RefreshLoading
        - 토큰 갱신중일 때 "로그인 정보 확인 중"이라는 메시지가 보여지는 컴포넌트 구성
    - 재배포 후 확인
      - 토큰 갱신중일 때 보여지는 컴포넌트 내용이 잠깐 보여지고 바로 배포한 페이지 내용이 보여지기 때문에, 생각한대로 동작하지 않는 것 같음
      - 생각한 동작은 토큰이 갱신중이라면 계속 저 로딩중이라는 내용이 보여지고, 토큰 갱신이 완료되면 배포한 페이지가 보여지는 상황을 생각했는데, 로딩중 내용은 잠깐 보여지고 바로 배포한 페이지가 보여지기 때문에 내용을 수정하거나 삭제해야 함
      - 생각해보면, 저 동작이 토큰 갱신하는 동안 쭉 지속될 수 가 없는데 잘못 생각했던 것 같음
      - 다른 방법을 찾아서 시도해볼 생각을 해야 함
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/8881150ae1eaa3694afd6dea84a0ba32622a8183)

  <br />

  - 로컬 스토리지 에러를 고치기 위한 해결책 테스트 (Context API의 로그아웃 함수 수정, 테스트를 위해 만료 시간 수정)
    - 백엔드
      - jwt-auth
        - 액세스 토큰 만료 시간을 4분으로 수정
      - user-routes
        - 액세스 토큰 만료 시간을 4분으로 수정
        - 리프레쉬 토큰 만료 시간을 20분으로 수정
    - 프론트엔드
      - auth-context
        - 액세스 토큰 유효 시간을 4분으로 수정
        - 인터벌 시간을 2분으로 수정
        - 로그아웃 함수에서 코드 순서 변경
          - role 항목을 변수에 저장하는 내용이 제일 앞 쪽으로 가도록 구성
          - 로컬 스토리지 초기화 내용이 쿠키 삭제 내용보다 앞에 위치하고 role 변수 다음에 위치하도록 구성
          - role 항목을 확인해서 admin 내용이 들어가 있다면 홈으로 이동하는 내용이 그 다음 동작하도록 구성
          - 마지막으로 쿠키 내용을 삭제하는 내용이 위치하도록 구성
    - 재배포 후 확인
      - 만료 시간을 줄인 상태로 다시 배포해서 테스트 해본 결과, 브라우저를 닫은 상태로 리프레쉬 토큰 만료 시간이 지난 후에 다시 배포한 사이트를 접속하면 로그아웃이 되어 있고, 쿠키에 저장된 토큰 또한 삭제되어 있는 것을 확인
      - 정확히 말하면 로컬 스토리지 내용이 초기화되어 있고, 쿠키 내용 또한 초기화된 것을 확인
      - 계속 브라우저를 닫은 채로는 useEffect가 작동하지 않아서, 다시 브라우저에 접속했을 때 만료 시간을 확인해서 로그아웃 함수가 작동은 했지만 뒤늦게 작동해서 로컬 스토리지 내용이 즉시 초기화되지 않았던 것 같은데, 이번에 테스트할 때는 한참 시간이 지나서 서버와 백엔드가 잠든 후에 다시 브라우저를 접속했는데도 로그아웃이 되어 있고 로컬 스토리지와 쿠키가 초기화된 것을 확인할 수 있었다.
      - 일단은 문제없이 작동하는 것 같긴 하지만, 추가로 만료 시간을 길게 설정해서 다시 한 번 확인을 해보는 게 좋을 것 같다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/9d5fcbd72b3f884dd363b7a4a5933f15b1c5e1e5)

<br />

- 추가 및 해결 해야 할 내용
  - 마지막 기능 추가로, 관리자 권한을 부여하는 내용을 생각하고 있음
    - 가입할 때는 일반 사용자로 가입을 할 수 있고, admin 관리자 계정으로 관리자 페이지에서 관리자 권한을 부여하는 내용을 생각 중
  - 새롭게 발견한 문제
    - 관리자 채팅의 사용자 리스트에서 사용자와 나눈 마지막 메시지 내용을 가져오는데, 이 때 새로고침을 하지 않으면 당장 채팅을 나눠도 실시간으로 마지막 메시지가 갱신되지 않아서 새로운 메시지가 있는 지 확인할 수 없기 때문에 추가하는 것도 고려해야 함
    - 한편으로는, 관리자 채팅이라서 사용자가 겪는 불편함이 아니기 때문에 그냥 놔두는 것도 고려 중
  - 배포한 사이트 확인
    - 추가 오류
      - 배포한 사이트에서 로그인하고 일정 시간이 지난 후에 자동으로 로그아웃 되면서 쿠키에 저장된 데이터는 삭제되지만, 로컬 스토리지에 저장된 데이터는 삭제되지 않는 문제가 발생해서 이 부분에 대한 수정이 필요
        - 이 문제는 일단 코드는 정상 작동하지만, 무료 서버와 백엔드로 인해서 발생하는 것으로 확인
        - 추가 확인을 위해서 토큰 만료 시간을 대폭 줄여서 다시 테스트 진행해봐야 함
        - 내용을 다시 확인해보니, 무료 서버와 백엔드의 문제가 아닌 브라우저가 꺼진 상태에서는 useEffect가 작동하지 않아서 발생하는 오류이기 때문에 다시 브라우저를 켰을 때 토큰 만료 시간을 확인해서 로그인이 유지되거나 로그아웃되도록 구성을 변경해줘야 함
        - 다른 방법으로, 토큰 유효 시간을 확인하는 if문에서 true가 될 경우, refreshTokenHandler 함수가 아닌, verifyUser 함수가 작동되는 것을 어떨 지 생각해봐야 함
        - 또 다른 방법으로, 차라리 토큰 유효 시간을 액세스 토큰과 리프레쉬 토큰 둘 다 길게 지정하고 인터벌 또한 자주 발생하지 않도록 하는 것도 고려를 해봐야 함
        - 자주 갱신하지 않고 유효 시간을 길게 지정하면 굳이 사용자 정보가 쿠키에서 사라지는 불편함을 겪지 않아도 되기에 고려해봐야 함
        - 로컬 스토리지 초기화가 되긴 하지만, role 항목은 사라지지 않은 것을 확인
    - UI를 수정해주고 최종 확인이 필요함
    - 로컬 스토리지 초기화 오류를 해결한다면 해결한 방법에 대한 정리가 필요

# 오늘 느낀 점

- 어제 다른 코드 커밋을 하지 않았지만, 로컬 스토리지 초기화 오류를 해결하기 위해서 관련된 내용을 찾아보고 오늘 다 테스트해봤는데 원하는 결과가 나오지 않아서, 예전에 찾아놓고 테스트해보지 않은 내용을 한 번 테스트해봤는데 꽤 만족스럽게 결과가 나온 것 같다. 아직 토큰 만료 시간을 늘린채로 다시 테스트해보지 못해서 추가로 테스트를 해봐야 하지만, 일단 토큰 만료 시간을 조금 짧게 구성한 상태에서는 생각한 동작이 이루어져서 기대해봐도 될 것 같다. 만약 이 방법으로도 해결이 안된다면 차라리 토큰 시간을 조금 길게 구성해서, 자주 갱신하는 불편함없이 사용할 수 있도록 해줄 생각이다. 보안성은 조금 떨어지지만 UX에서는 장점이 생기고 로컬 스토리지 초기화 오류 같은 문제가 적게 발생하기 때문에 토큰 갱신 시간을 대폭 늘릴 생각이다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
