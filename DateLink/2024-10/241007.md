# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 로컬 스토리지 에러를 고치기 위한 해결책 테스트 (토큰 갱신 시간 수정)
    - 백엔드
      - jwt-auth
        - 액세스 토큰 만료 시간을 30분으로 수정
      - user-routes
        - 액세스 토큰 만료 시간을 30분으로 수정
        - 리프레쉬 토큰 만료 시간을 2시간으로 수정
    - 프론트엔드
      - auth-context
        - 액세스 토큰 유효 시간을 30분으로 수정
        - 인터벌 시간을 15분으로 수정
    - 재배포 후 확인
      - 액세스 토큰과 리프레쉬 토큰 만료 시간을 원래대로 수정하고 테스트해본 결과, 토큰 만료 시간을 짧게 구성하고 테스트했을 때와 동일하게 브라우저를 닫고 만료 시간이 한참 지난 후에 다시 배포한 사이트에 접속하면, 로그아웃이 되어 있고 로컬 스토리지와 쿠키 내용이 초기화되어 있는 것을 확인할 수 있었다.
      - 우려했던 것과 달리 만료 시간이 지나고 브라우저에 다시 접속하면 로그아웃이 정상적으로 이루어져있는 것을 확인
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/4eade0db8ab4a15dfaf949619b18adde74322d11)

  <br />

  - auth Context API 내용 수정 및 RefreshLoading 내용 삭제 (isRefreshing 내용, theme mode 내용 삭제)
    - 프론트엔드
      - RefreshLoading 관련 파일 삭제
      - auth-context
        - 주석 처리했던 테마 모드 관련 코드를 모두 삭제
        - isRefreshing useState 삭제
        - checkTokenExpiration 함수에서 async-await 삭제
        - checkTokenExpiration 함수에서 isRefreshing과 관련된 내용 삭제
          - try-catch-finally 내용 삭제
        - JSX 코드 내용에서 isRefreshing를 조건부로 확인하는 내용과 RefreshLoading 컴포넌트가 렌더링 되는 내용 삭제
          - children만 사용될 수 있도록 구성
    - 재배포 후 확인
      - 다시 배포한 후에 확인해보니 RefreshLoading 관련 내용이 보여지지 않는 것을 확인
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/feef8bbd9c1faffe48986cd84cd9ff5253a68dc0)

  <br />

  - 로컬 스토리지 에러를 고치기 위한 테스트 (테스트를 위해 만료 시간 수정, 로그아웃 함수 수정)
    - 오류를 해결하기 전에 정확히 어떤 부분이 문제였는 지, 더 정확히 파악하기 위해서 이전 로그아웃 함수 내용과 토큰 만료 시간을 수정해서 테스트
    - 백엔드
      - jwt-auth
        - 액세스 토큰 만료 시간을 10분으로 수정
      - user-routes
        - 액세스 토큰 만료 시간을 10분으로 수정
        - 리프레쉬 토큰 만료 시간을 1시간으로 수정
    - 프론트엔드
      - auth-context
        - 액세스 토큰 유효 시간을 10분으로 수정
        - 인터벌 시간을 5분으로 수정
        - 기존의 로그아웃 함수를 주석 처리하고, 이전에 사용하던 로그아웃 함수를 그대로 구성
    - 재배포 후 확인
      - 리프레쉬 토큰 만료 시간은 수정이 된 것을 확인할 수 있었지만, 액세스 토큰 만료 시간은 그대로 30분으로 되어 있어서 코드를 잘못 수정하고 배포했는 지 확인해봤으나, 정상적으로 수정하고 배포한 것을 확인
      - 액세스 토큰 만료 시간이 제대로 변경되지 않은 이유는, 빌드 과정에서 오류가 발생해서 일부분만 변경된 것으로 예상됨
      - RefreshLoading 컴포넌트 내용을 삭제하면서 import한 내용은 남겨두어서 오류가 발생했으므로, import한 내용을 삭제하고 다시 배포해줘야 함
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/29e9ca6efaea289444c3d448c87720417bcd9cf0)

  <br />

  - 빌드 오류 해결
    - 프론트엔드
      - auth-context
        - import 했던 RefreshLoading 컴포넌트 내용을 삭제
        - console.log(now) 내용 주석 처리
        - if-else if문의 항목 내용을 콘솔에서 더 정확히 알 수 있도록 텍스트 추가
    - 재배포 후 확인
      - 사용하고 있던 RefreshLoading 컴포넌트 내용을 삭제하고, import한 내용은 삭제하지 않아서 빌드 과정에서 오류가 발생
      - import한 RefreshLoading 내용을 삭제하고 배포하니 문제없이 빌드되는 것을 확인
      - 앞에서 수정한 토큰 만료 시간 내용을 테스트해본 결과, 역시나 리프레쉬 토큰 만료 시간이 지난 후에 배포한 사이트에 접속하면 로그아웃이 되어 있지 않고, 로컬 스토리지 내용이 초기화되지 않은 것을 확인
        - 쿠키의 내용만 초기화되어 있음
      - 마지막 테스트로, 액세스 토큰과 리프레쉬 토큰 만료 시간을 대폭 늘린 후에도 문제가 없는 지 확인해줘야 함
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/e2a33aa4d7fecaa6d4e5231b9cdabb04fabd2067)

<br />

- 추가 및 해결 해야 할 내용
  - 마지막 기능 추가로, 관리자 권한을 부여하는 내용을 생각하고 있음
    - 가입할 때는 일반 사용자로 가입을 할 수 있고, admin 관리자 계정으로 관리자 페이지에서 관리자 권한을 부여하는 내용을 생각 중
  - 새롭게 발견한 문제
    - 관리자 채팅의 사용자 리스트에서 사용자와 나눈 마지막 메시지 내용을 가져오는데, 이 때 새로고침을 하지 않으면 당장 채팅을 나눠도 실시간으로 마지막 메시지가 갱신되지 않아서 새로운 메시지가 있는 지 확인할 수 없기 때문에 추가하는 것도 고려해야 함
    - 한편으로는, 관리자 채팅이라서 사용자가 겪는 불편함이 아니기 때문에 그냥 놔두는 것도 고려 중
  - 배포한 사이트 확인
    - 추가 오류
      - 배포한 사이트에서 로그인하고 일정 시간이 지난 후에 자동으로 로그아웃 되면서 쿠키에 저장된 데이터는 삭제되지만, 로컬 스토리지에 저장된 데이터는 삭제되지 않는 문제가 발생해서 이 부분에 대한 수정이 필요
        - 이 문제는 일단 코드는 정상 작동하지만, 무료 서버와 백엔드로 인해서 발생하는 것으로 확인
        - 추가 확인을 위해서 토큰 만료 시간을 대폭 줄여서 다시 테스트 진행해봐야 함
        - 내용을 다시 확인해보니, 무료 서버와 백엔드의 문제가 아닌 브라우저가 꺼진 상태에서는 useEffect가 작동하지 않아서 발생하는 오류이기 때문에 다시 브라우저를 켰을 때 토큰 만료 시간을 확인해서 로그인이 유지되거나 로그아웃되도록 구성을 변경해줘야 함
        - 다른 방법으로, 토큰 유효 시간을 확인하는 if문에서 true가 될 경우, refreshTokenHandler 함수가 아닌, verifyUser 함수가 작동되는 것을 어떨 지 생각해봐야 함
        - 또 다른 방법으로, 차라리 토큰 유효 시간을 액세스 토큰과 리프레쉬 토큰 둘 다 길게 지정하고 인터벌 또한 자주 발생하지 않도록 하는 것도 고려를 해봐야 함
        - 자주 갱신하지 않고 유효 시간을 길게 지정하면 굳이 사용자 정보가 쿠키에서 사라지는 불편함을 겪지 않아도 되기에 고려해봐야 함
        - 로컬 스토리지 초기화가 되긴 하지만, role 항목은 사라지지 않은 것을 확인
    - UI를 수정해주고 최종 확인이 필요함
    - 로컬 스토리지 초기화 오류를 해결한다면 해결한 방법에 대한 정리가 필요
  - 배포하는 과정에서 오류가 생겼던 부분과 해결한 오류에 관한 내용을 정리해줘야 함
    - CORS 오류, Rewrite 관련 내용 등

# 오늘 느낀 점

- 로컬 스토리지 초기화 오류를 해결하기 위해서 로그아웃 함수 내에서 코드 위치를 변경해주었는데 이 방법이 해결책이었던 것 같다. 배포한 사이트에 접속해서 로그인하고, 브라우저를 닫고 리프레쉬 토큰이 만료될 시간이 지난 후에 배포한 사이트에 다시 접속하면 정상적으로 로그아웃이 되어 있고 로컬 스토리지와 쿠키가 모두 초기화되어 있는 것을 확인할 수 있었다. 이제 브라우저를 닫은 상태에서도 토큰 만료 시간이 지나면 로그아웃이 되는 것을 확인했으니 브라우저를 켜놓은 상태에서 토큰 만료 시간이 지나면 문제없이 로그아웃이 되는 지 확인해주고, 액세스 토큰과 리프레쉬 토큰 만료 시간을 맨 처음에 사용하던 만료 시간으로 변경해서 긴 만료 시간에서도 문제가 없는 지 확인해줄 생각이다.

- 로컬 스토리지 초기화 문제와 관련해서 마지막 테스트를 진행하고, 전체적으로 기능이 동작하는데 문제가 없는 지 확인해주고, UI는 이상이 없는 지, 모바일 환경에서는 문제가 없는 지 확인해줄 생각이며, Rewrite 관련해서 새로고침 문제를 해결해줬었는 데 이 부분 또한 문제가 없는 지 다시 확인해줘야 한다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
