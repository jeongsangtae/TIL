# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 콘솔 로그 관련 코드 정리 (주석 처리 또는 삭제 처리)
  - 테스트를 위해 추가했던 콘솔 로그 내용들이 너무 많아서 정작 필요한 내용은 확인을 하지 못하기에 삭제 및 주석 처리로 정리
  - 프론트엔드
    - chatStore, friendStore, groupChatStore, socketStore, DirectChats
      - 해당 컴포넌트와 Zustand 내부에 구성되어 있는 콘솔 로그 내용들을 삭제 및 주석 처리
  - 콘솔 로그 내용들을 삭제 및 주석 처리해 주고 확인할 결과, 콘솔창에서 필요한 내용만 출력되는 것을 확인할 수 있었다.
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/02097d42be4f4b0793a81130f5480aa2965b42f4)

<br />

- 새로운 메시지 알림 수신과 관련된 오류 체크
  - 발생한 오류
    - 로그인하고 다른 사용자가 메시지를 추가하면 새로운 메시지 알림이 넘어오지 않음
      - 친구 요청 알림, 그룹 채팅방 초대 알림은 문제없이 실시간 알림 메시지가 넘어오는 것을 확인
      - 새로운 메시지 알림은 그룹 채팅방에 한번 들어가야 전송되어 출력되는 것을 확인
    - 그룹 채팅방을 들어갈 때마다, 이벤트 리스너가 중복되어 알림 메시지가 넘어오면 여러번 중복되어 출력됨
      - 중복 방지를 위해 `.off` 내용을 추가해 구성해도 해결되지 않음
      - joinRoom 액션에 새로운 메시지 알림과 관련된 `.off`를 추가해 테스트한 결과, 실시간 새로운 메시지 알림이 넘어오지 않는 것을 확인
      - some을 사용해 중복되는 내용을 삭제하고 출력하도록 구성해도 해결이 되지 않는 것을 확인
  - 오류 원인 파악 및 생각한 해결 방법
    - 프론트엔드 로직에서는 크게 문제가 없어보이지만, 백엔드에서 다른 구조로 구성된 내용 때문에 오류가 발생하는 것으로 추측
      - 새로운 메시지 알림 관련 백엔드 로직에서 참여한 그룹 채팅방 목록을 확인하고, 그 그룹 채팅방에서 발생한 메시지에 대해 알림이 넘어오도록 수정이 필요
    - 그룹 채팅방에 입장하면 새로운 메시지 알림 수신 이벤트가 연결되는데, 이 부분도 수정해서 그룹 채팅방 입장과 관련된 로직을 삭제하는 것도 고려해야 함
      - 그룹 채팅방 입장과 관련된 액션 내용이 반드시 필요한 내용인지 확인도 필요
    - 최우선으로, 백엔드에 구성된 새로운 메시지 알림 이벤트와 관련된 로직에서 방 관련된 내용을 삭제하고 새로운 방식으로 재구성해서 테스트해야 함
    - joinRoom 액션에 새로운 메시지 알림과 관련된 소켓 내용을 옮겨서 구성하는 것도 고려를 했으나, 전체적으로 실시간 알림과 관련된 내용은 로그인 후에 바로 모두 연결되도록 전역적으로 관리하는 것이 맞다고 생각 됨

<br />

- 실시간 알림 메시지 관련 내용에 대한 구조 및 설명 그리고 문제
  - 그룹 채팅방 외 알림 수신
    - 그룹 채팅방에 들어가 있지 않더라도 다른 사용자가 그룹 채팅방에 메시지를 추가하면 알림을 보내야 함
    - 들어가 있지 않다는 것은 현재 해당 그룹 채팅방 화면을 보고 있지 않는 상황을 말함
  - 백엔드 로직 의심
    - 프론트엔드 로직에서 발생하는 중복 알림 문제는 백엔드가 알림을 처리할 때 문제가 있을 가능성이 큼
    - 메시지 알림이 각 사용자의 그룹에 대해 제대로 발송되지 않는다면, 백엔드에서 해당 그룹의 사용자에게만 알림을 보내도록 해야 함
  - 현재 로직의 문제 (알림 중복 발송)
    - 문제
      - 새로운 메시지 알림이 중복으로 발송되는 문제는 소켓 이벤트 리스너가 중복 등록되기 때문에 발생
      - connect 액션에서 `newSocket.on("messageNotification")` 이벤트 리스너가 계속해서 추가되어서 알림이 중복으로 발생
    - 시도한 해결 방법
      - `newSocket.off("messageNotification")`를 사용하여 이벤트 리스너를 제거하는 로직을 추가했지만, 여전히 해결이 되지 않음
      - some을 추가해 중복 방지를 시도해도 해결이 되지 않음
  - 전역적으로 메시지 알림 수신
    - 새로운 메시지 알림은 전역적으로 알림을 받을 수 있도록 해야 하며, connect 액션 내에서 알림 수신을 관리하는 것보다는 알림 관련 로직을 별도로 분리하고, 해당 알림들을 관리하는 중앙 상태를 사용하는 것도 고려해야 함
  - 문제 발생 시점 (방 참여 전 알림 미수신)
    - 새로운 메시지 알림만 방에 참여 후에 수신된다는 부분은 프론트엔드에서 해당 방에 참여한 후에 알림 리스너를 등록하는 방식이 원인일 수 있음
    - 방에 입장하기 전에는 해당 방에서 발생한 메시지 알림을 수신하지 않기 때문에 방에 참여 후 알림을 받게 됨
    - 이를 해결하기 위해서는 방에 입장하기 전에 새로운 메시지 알림을 수신할 수 있도록 전역적으로 메시지 알림을 처리하는 방식으로 변경해야 함
  - 전역 상태 관리 및 알림 이벤트 리스너
    - 알림 수신 이벤트 리스너는 한 번만 등록되어야 하며, 각 방에 입장할 때마다 리스너를 새로 등록하는 방식은 피해야 함
    - 소켓 연결을 초기화할 때 한 번만 등록되고, 나중에 새로운 방에 입장하더라도 기존의 이벤트 리스너는 그대로 유지되도록 해야 함
  - 개선 방안
    - connect 액션에서 알림 리스너를 한 번만 등록하고, 그 이후에는 방에 참여하는 것과는 관계없이 알림을 받을 수 있도록 개선해야 함
    - connect 액션에서 소켓을 설정할 때 한 번만 리스너를 등록하고, 이후 joinRoom에서는 방에 참여하는 것만 처리
    - 알림을 받는 로직은 전역 상태에서 처리되므로 방에 관계없이 항상 알림을 받을 수 있도록 해야 함
  - 로그인/로그아웃 문제
    - 로그인 후 알림 수신이 친구 요청, 그룹 초대 알림 등은 잘 작동하지만, 새로운 메시지 알림만 방에 입장해야 수신되고 있는데, 이는 소켓 연결 후 메시지 알림 수신 리스너 등록이 방에 입장할 때마다 초기화되기 때문임
    - 알림 리스너는 소켓 연결 시 한 번만 등록되도록 수정이 필요
  - 알림 리스너 분리
    - 새로운 메시지 알림 관련 내용을 따로 관리하는 것도 방법이지만, 모든 알림 이벤트를 한 곳에서 처리하는 것이 유지보수에 용이함
  - 최종 정리
    - connect 액션에서 소켓 연결 후 알림 이벤트 리스너를 한 번만 등록하고, 이후 방에 입장하는 것과는 관계없이 해당 알림을 수신할 수 있도록 개선해야 함
      - 프론트엔드 로직에서는 문제가 없어보이며, 백엔드 로직에서 문제가 있다고 추측
    - 알림 관련 이벤트는 socketStore에서 한 번만 등록하고, 이후 새로운 방에 입장하더라도 이미 등록된 리스너로 알림을 받을 수 있게 해야 함
    - 중복 알림을 방지하고, 방에 입장하지 않아도 알림을 전역적으로 수신할 수 있도록 수정이 필요

# 오늘 느낀 점

- 참여한 그룹 채팅방에서 새로운 메시지가 추가되었을 때 실시간 알림이 전송되도록 하는 로직이 작동을 하긴 하지만, 알림 메시지가 중복으로 전송되어서 여러번 출력이 되기 때문에 중복 방지 내용을 추가하고 테스트해 봤으나, 해결이 되지 않아서 정확한 원인을 파악하고 추가 테스트를 진행해 봐야 한다. 추가적인 문제로 새로운 메시지 알림과 관련된 이벤트만 로그인 시에 바로 등록되지 않고 그룹 채팅방에 접속해야 등록되기 때문에 이 부분에 대한 추가 수정도 필요하고, 여기에 추가로 현재 참여한 채팅방을 확인하고 해당 채팅방을 제외한 나머지 그룹 채팅방에서 실시간 알림 메시지가 넘어오도록 구성을 해 줘야 한다. 친구 관련 내용에서도 문제를 발견했는데, 친구를 삭제하면 실시간 반영이되지 않는 문제가 있고, 친구를 삭제했을 때 해당 친구와 관련된 그룹 채팅방 초대 메시지 내용도 삭제되지 않아서 이 부분에 대한 수정이 필요하다. 실시간 알림 메시지 관련해서 정리한 내용을 참고하여 로직을 수정해야 하고, 여러 오류들과 추가로 발견한 오류까지 모두 처리를 해 줘야 할 것 같다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 그룹 채팅방 제목 수정과 관련된 실시간 반영이 되는지 확인 필요

- 새로운 메시지 추가되었을 때 알림 뜨는 기능 (로그인하고, 방에 들어가지 않았어도 알림이 넘어오도록 수정해야 하며, 참여한 모든 방에 대해 알림 메시지가 넘어와야 한다고 생각은 하는데, 현재 참여한 채팅방을 제외하고 넘어오도록 하는 것도 고려를 해야 함)

- 친구 삭제했을 때 실시간 반영이 되도록 로직 구성 필요

- 친구를 삭제했을 때, 해당 친구와 관련된 그룹 채팅방 초대 메시지 삭제 필요

- 친구 관련된 내용에서 코드 정리 필요 (코드를 깔끔하게 보이도록 수정 필요)

- 그룹 채팅방에서 채팅 메시지가 추가되면 전역적으로 알 수 있도록 알림이 떠야 하고, 그 알림 관리를 소켓 Zustand에서 할 수 있도록 구성 필요

- 그룹 채팅방 초대하고 알림을 전송하는 기능에서, 로그인한 사용자가 아닌 친구에게 보내는 그런 구조로 작동되도록 수정이 필요 (비로그인 상태여도 상관이 없음 단순하게 친구한테 친구 요청하면 알림 메시지가 전달되어야 함)

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
