# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 그룹 채팅방 떠나는 액션, 소켓 이벤트 추가 (새로운 메시지 에러 수정)
  - 그룹 채팅방에 입장하고 다른 그룹 채팅방으로 이동할 때, 이전 그룹 채팅방은 나가도록 액션과 소켓 이벤트를 추가해 새로운 메시지 추가 시에 현재 보여지는 그룹 채팅방에서만 메시지가 추가되어 출력되고, 다른 그룹 채팅방에서는 출력되지 않도록 에러 수정
  - 백엔드
    - app
      - leaveRoom 이벤트 추가
        - 현재 참여한 그룹 채팅방 번호를 전달받도록 구성
        - chatRoomId에 방 번호를 저장
        - `socket.leave(chatRoomId)`로 해당 방을 나가도록 구성
        - 방을 나간 후에 콘솔에 나갔다는 메시지와 나간 방 번호 표시
  - 프론트엔드
    - socketStore
      - leaveGroupChat 액션 타입 정의 추가
        - 일반 함수 타입으로 정의
      - leaveGroupChat 액션 추가 (주석 처리풀고 활성화)
        - socket을 `get().socket`으로 불러오고, 유효한지 확인
          - 추가로, 현재 참여한 그룹 채팅방 상태도 유효한지 함께 확인
        - socket.emit을 통해 leaveRoom 이벤트에 현재 참여한 그룹 채팅방 번호를 전달
        - set을 통해 현재 참여한 그룹 채팅방 상태를 null로 업데이트
        - 로컬 스토리지에 저장된 currentRoom 항목을 삭제하도록 구성
        - 채팅방을 나갔다는 메시지를 콘솔에 출력
    - Chats
      - useSocketStore에서 leaveGroupChat 액션을 추가로 불러오도록 구성
      - joinGroupChat 액션이 실행되는 useEffect에 leaveGroupChat 액션을 추가
        - joinGroupChat 액션 앞에 leaveGroupChat 액션을 추가해서 방 참여 전에 먼저 방 나가는 액션이 실행되도록 구성
        - leaveGroupChat 액션을 먼저 실행시켜서 기존 방을 나가고, 그 다음 joinGroupChat 액션으로 새로운 방에 입장
        - 방을 이동할 때 불필요한 메시지 수신 문제를 해결할 수 있게 됨
        - 기존 방에서 등록된 이벤트가 해제되면서, 메시지 수신 문제 해결
  - 다른 그룹 채팅방에 참여하기 전에, 기존의 그룹 채팅방을 나가도록 구성하고 테스트한 결과, A라는 그룹 채팅방에서 새로운 메시지가 추가되면 B라는 그룹 채팅방에서 똑같이 출력되는 것이 아닌, A라는 그룹 채팅방에서만 출력되는 것을 확인할 수 있었다.
    - 이전에 참여했던 그룹 채팅방 이벤트가 제거되면서, 그룹 채팅방에서 추가되는 메시지 출력 오류는 해결이 되었기 때문에, 새로운 메시지 알림과 관련해서 추가 수정을 해 줘야 함
    - 새로운 메시지 알림이 해당 그룹 채팅방에 있을 경우에는 넘어오지 않고, 다른 그룹 채팅방이나 홈에 있을 경우에만 넘어오도록 수정해야 함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/444af4aa559045daa297961f088f3d22a0c11973)

<br />

- 현재 방에 있는 사용자 목록을 관리하는 로직을 활성화 및 그룹 채팅방 떠나는 이벤트 수정 및 홈으로 이동하는 내용 수정
  - 새로운 메시지 추가 시에 알림이 전송되는데, 이 때 현재 그룹 채팅방에 참여한 사용자에게는 알림 메시지가 전송되지 않도록 구성해 주고, 홈으로 이동할 경우 방을 나가는 액션 및 이벤트가 작동되어서 어떤 방에도 참여하지 않은 상태가 되어, 모든 그룹 채팅방에서 새롭게 추가된 메시지에 대한 알림이 전송되어 보여지도록 구성
  - 백엔드
    - app
      - leaveRoom 이벤트 내용에 그룹 채팅방을 떠날 때 자동으로 roomUsers 목록에서 사용자 socket.id가 제거되도록 로직 추가
        - `roomUsers.has(chatRoomId)`를 사용해 해당 채팅방이 존재하는지 확인
        - 존재할 경우, set()을 호출하고 ` roomUsers.get(chatRoomId)`를 통해 chatRoomId에 속한 사용자들의 socket.id 목록을 가져오도록 구성
        - `.filter((id) => id !== socket.id)`를 사용해 현재 나가는 socket.id와 일치하지 않는 요소들만 남기도록 구성
        - 최종적으로 나가는 사용자를 특정 채팅방에서 제거
        - 작동 방식
          - roomUsers에 해당 방이 존재하는지 확인
          - 기존 사용자의 목록을 가져옴
          - .filter를 사용해 socket.id 제거
          - roomUsers.set을 사용해 새로운 사용자 목록을 적용
      - roomUsers와 관련된 내용 주석을 풀고 다시 사용할 수 있도록 구성
    - group-chat-routes
      - 사용자가 입력한 채팅 메시지를 저장하는 POST 라우터 수정
        - roomUsers와 관련된 주석을 풀고 사용할 수 있도록 구성
        - `if (socketId && !roomSockets.includes(socketId)) {..}` 조건부로 수정
          - socketId가 roomSockets 배열에 포함되지 않으면 true가 되도록 구성
          - `!roomSockets.includes(socketId)`로 인해 현재 방에 없는 사용자를 확인하고, 해당 사용자들에게만 알림을 보내도록 구성
          - 최종적으로 이전에 구성한 `if (userId === othersData._id.toString()) return;` 로직까지 포함해서, 메시지를 보낸 사용자는 제외하고 방에 접속하지 않은 사용자들만 알림을 받게 됨
  - 프론트엔드
    - RootLayout
      - useNavigate Hook을 추가하고 사용할 수 있도록 구성
      - useSocketStore Zustand에서 leaveGroupChat 액션을 불러오고 사용할 수 있도록 구성
      - leaveGroupChatHandler 함수 추가
        - leaveGroupChat 액션이 먼저 실행되고, 그 다음 navigate로 인해 홈으로 이동되도록 구성
      - JSX 코드 수정
        - Link 컴포넌트를 사용해 홈으로 이동시키는 버튼을 주석 처리
        - button을 추가하고, onClick에 leaveGroupChatHandler 함수를 추가해 실행되도록 구성
  - 구성한 내용을 테스트한 결과, 현재 참여한 그룹 채팅방에서 새로운 메시지가 추가되면 알림이 전송되지 않는 것을 확인했고, 다른 그룹 채팅방에서 새로운 메시지가 추가되면 알림이 전송되어 보여지는 것도 확인할 수 있었고, 홈에 있을 경우에는 모든 그룹 채팅방에서 새로운 메시지가 추가되면 알림이 전송되어 보여지는 것도 확인할 수 있었다.
    - 그룹 채팅방 메시지와 관련된 오류 및 실시간 알림 관련 오류도 모두 수정했기 때문에, 그룹 채팅방 제목 수정 실시간 반영 및 친구 삭제와 관련된 내용이 실시간 반영되도록 구성을 추가해 줘야 함
    - 내용을 구성할 때 추가했던 콘솔 로그 및 주석 처리하고 사용하지 않는 내용들을 정리해 줘야 하고, 변경이 필요한 함수 이름도 수정해야 함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/612d3f7e4f7f322224bcb0e38d1b2806a28ba911)

# 오늘 느낀 점

- 그룹 채팅방 나가기와 관련된 액션 및 이벤트를 추가해서, 새로운 메시지 추가 시에 다른 그룹 채팅방에서도 출력되는 오류를 수정해 주었으며, 방에 참여한 사용자 목록을 관리해서 새로운 메시지 추가 시에 해당 사용자들을 제외한 사용자에게 메시지 추가와 관련된 알림을 전송할 수 있게 되었다. 그룹 채팅방 제목 수정 시에 실시간 반영이 되는지 확인하고, 만약 반영이 되지 않는다면 실시간으로 적용되도록 내용 구성이 필요하며, 친구 삭제와 관련된 내용이 실시간 반영도 되지 않고 있으며, 친구를 삭제할 때 해당 친구와 관련된 그룹 채팅방 초대 메시지 같은 내용이 함께 제거되지 않는 문제가 있기 때문에 수정을 해 줘야 한다. 그리고 그룹 채팅방 메시지와 관련된 오류 및 실시간 알림 관련 오류를 수정하면서 추가했던 콘솔 로그 및 테스트하고 주석 처리한 채로 사용하지 않는 내용들을 제거해 전체적으로 코드 정리를 한 번 해 주는 것이 좋다고 생각이 된다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 그룹 채팅방 제목 수정과 관련된 실시간 반영이 되는지 확인 필요

- 친구 삭제했을 때 실시간 반영이 되도록 로직 구성 필요

- 친구를 삭제했을 때, 해당 친구와 관련된 그룹 채팅방 초대 메시지 삭제 필요

- 친구 관련된 내용에서 코드 정리 필요 (코드를 깔끔하게 보이도록 수정 필요)

- 그룹 채팅방 초대하고 알림을 전송하는 기능에서, 로그인한 사용자가 아닌 친구에게 보내는 그런 구조로 작동되도록 수정이 필요 (비로그인 상태여도 상관이 없음 단순하게 친구한테 친구 요청하면 알림 메시지가 전달되어야 함)

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
