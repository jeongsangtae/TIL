# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 그룹 채팅방 초대 실시간 반영 추가
  - 그룹 채팅방에 초대된 사용자 화면에 실시간으로 초대 메시지가 보여지도록 실시간 반영과 관련된 내용 추가
  - 백엔드
    - group-chat-routes
      - 그룹 채팅방 초대와 관련된 POST 라우터 수정
        - groupChatInvites 컬렉션에 저장되는 내용이 별도의 변수에 저장되도록 구성
          - socket 내용에 사용될 수 있도록 변수에 저장
        - groupChatInvites 컬렉션에 저장되는 내용이 직접 추가되는 것이 아닌, 변수를 사용해 저장되도록 수정
        - groupChatInvite 이벤트 관련된 socket 내용 추가
          - `io.to(receiverSocketId).emit("groupChatInvite", newGroupChatInvite)` 내용을 추가
          - groupChatInvite 이벤트 내용을 통해 새롭게 추가된 그룹 채팅방 초대 정보를 프론트엔드로 전달
  - 프론트엔드
    - groupChatStore
      - socket 관련 내용 추가
        - 타입 정의 및 socket 상태 추가
        - useSocketStore Zustand에서 socket 내용을 불러오도록 구성
      - getGroupChatInvites 액션 수정
        - 백엔드에서 구성한 socket 내용인 groupChatInvite 이벤트와 연결되도록 구성 추가
        - useSocketStore Zustand에서 불러온 socket을 구성
        - socket이 있는지 확인하는 내용 추가
          - 콘솔에 메시지를 띄우고, 조건부로 소켓이 있는지 확인
          - 소켓이 없을 경우 return으로 바로 종료
        - socket.on으로 groupChatInvite 이벤트 내용을 전달받도록 구성
          - 이전 상태를 반영하고 socket을 통해 전달받은 그룹 채팅방 초대 정보가 배열에 추가되며 업데이트되도록 구성
  - 그룹 채팅방에 초대된 사용자 화면에 초대 메시지가 실시간으로 보여지도록 내용을 구성하고 테스트한 결과, 초대 메시지가 실시간으로 넘어와 사용자 화면에 바로 출력되는 것을 확인할 수 있었다.
    - 알림과 초대 메시지가 함께 출력되며 보여지는 것을 확인했고, 알림은 일정 시간 후에 사라지는 것을 확인
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/031c74f75190e9d34cfd8dce80e3c5fbbec22485)

<br />

- 그룹 채팅방 초대 내용에 만료 시간 추가 및 그룹 채팅방 초대 수락 백엔드 로직 수정 및 그룹 채팅방 초대 버튼 조건부 수정
  - 그룹 채팅방 초대를 수락하면 해당 초대 내용 데이터가 DB에 남아있지 않고 삭제되도록 수정해 주었으며, 그룹 채팅방 초대를 요청한 후에 DB에 저장된 초대 데이터가 무한대로 남아있는 것이 아닌 일정 시간 후에 만료되어 사라지도록 구성을 추가해 주었고, 그룹 채팅방 초대 버튼 조건부를 이전 형태로 다시 수정
  - 백엔드
    - database
      - 기존의 인덱스를 삭제하는 코드 추가
        - 해당 코드는 매번 실행되는 것이 아닌, 필요할 때만 사용할 수 있도록 주석 처리
        - `await database.collection("groupChatInvites").dropIndex("date_1")`
        - groupChatInvites 컬렉션과 관련된 인덱스를 삭제하도록 구성
      - TTL 인덱스를 생성하는 내용 추가
        - `await database.collection("groupChatInvites").createIndex({ date: 1 }, { expireAfterSeconds: 86400 });`
        - groupChatInvites 컬렉션에 저장된 date 속성을 기준으로 24시간 후에 해당 문서가 자동으로 삭제되는 인덱스 추가
          - groupChatInvites 컬렉션에 문서가 삽입될 때, date 속성에 저장된 UTC 기준 시간을 기준으로 MongoDB가 내부적으로 타이머를 시작함
          - 해당 문서의 삽입 시간 + 24시간이 지나면, MongoDB가 자동으로 해당 문서를 삭제
          - 삭제 작업은 MongoDB의 백그라운드 프로세스에서 비동기적으로 실행되기 때문에, 애플리케이션 성능에 영향을 주지 않음
        - TTL 인덱스는 각 문서의 date 속성을 기준으로 개별적으로 만료 시간이 적용되기 때문에, 초대가 전달된 시간이 다르더라도 해당 초대 메시지가 생성된 시간으로부터 24시간 후에 개별적으로 삭제됨
          - 초대된 시간이 서로 다르더라도, 각 초대 메시지의 date 속성을 기준으로 만료 시간이 개별적으로 적용되므로 문제가 발생하지 않음
      - 현재 적용된 인덱스 목록을 확인하는 코드 추가
        - 이 내용 또한 매번 실행되는 것이 아닌, 필요할 때만 사용할 수 있도록 주석 처리
        - `const indexes = await database.collection("groupChatInvites").indexes();`
        - 이전에는 `indexes()` 대신에 `getIndexes()`를 사용했으나, MongoDB v4 이후에는 `indexes()` 메서드로 변경
    - group-chat-routes
      - 그룹 채팅방 초대와 관련된 POST 라우터 수정
        - DB에 저장되는 그룹 채팅방 초대 정보를 수정
          - date 속성은 `new Date()` 내용이 저장되도록 구성
          - kstDate 속성을 따로 추가해, 이전에 date에서 사용하던 내용을 그대로 사용
        - 그룹 채팅방 초대 정보를 전달하는 socket 내용에 주석 추가
      - 그룹 채팅방 초대를 수락하는 POST 라우터 수정
        - groupChatInvites 컬렉션 내용에서 status 속성을 "수락"으로 업데이트하는 대신에, deleteOne을 사용해 수락된 그룹 채팅방 초대 내용이 삭제되도록 구성
  - 프론트엔드
    - GroupChatInviteList
      - props로 전달받는 status 내용 삭제
      - 로그인한 사용자가 요청을 받은 사람이 맞는지 확인하는 내용과 status 항목에 "보류" 내용이 있는지 확인하는 조건부를 삭제
      - JSX 코드
        - 로그인한 사용자가 요청을 받은 사람이 맞는지 확인하는 내용으로 조건부 수정
    - DirectChats
      - groupChatInvite.status 내용이 전달되지 않도록, status props 삭제
    - types
      - GroupChatInviteListProps 타입 정의 수정
        - 더이상 사용되지 않는 status 항목을 삭제
  - 내용을 수정하고 테스트한 결과, 그룹 채팅방 초대를 수락하면 초대 데이터가 업데이트되는 것이 아닌, 해당 초대 데이터는 사라져 DB에서 보이지 않는 것을 확인할 수 있었고, 그룹 채팅방 초대 데이터가 수락 또는 거절되지 않은 채로 계속 남아있을 경우 설정한 만료 시간 후에 데이터가 사라지는 것도 확인했으며, 그룹 채팅방 초대 버튼 조건부가 이전보다 좀 더 간결하게 구성된 것을 확인할 수 있었다.
    - 여전히 그룹 채팅방 삭제 시에 상대방 화면에서는 그대로 남아있기 때문에, 이와 관련해서 내용을 수정해 줘야 함
    - 그룹 채팅방 삭제 및 수정 권한을 호스트만 가능하도록 수정도 해 줘야 함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/a46044596029e8da15dba0bbe6544e570fc76f42)

# 오늘 느낀 점

- 그룹 채팅방 초대 요청이 상대방 화면에 실시간 반영되도록 구성을 추가해 주었고, 그룹 채팅방 초대를 수락하면 해당 데이터가 바로 삭제되어 DB에 남아있지 않도록 변경해 주었으며, 그룹 채팅방 초대 보류 상태에서 24시간이 지나면 자동으로 DB에서 해당 데이터가 삭제되도록 내용을 추가해 주었다. 그룹 채팅방 삭제와 관련된 실시간 반영은 다시 테스트해 보지 못했는데, 그룹 채팅방 초대 요청과 마찬가지로 이것도 상대방 화면에서 바로 적용이되도록 구성을 해야 하는데, 이번에 구성한 그룹 채팅방 초대 요청 실시간 반영 로직을 참고해 구성하면 해결할 수 있을 것 같다는 생각이 들어서 빠르게 테스트해 봐야 할 것 같다. 그리고 그룹 채팅방을 수정 또는 삭제할 수 있는 권한을 호스트에게만 부여하도록 수정해 줘야 하는데, 생각한 방법으로는 호스트 정보를 전달받고 해당 정보를 확인해 일치할 경우에만 수정 또는 삭제 버튼이 보여지고, 호스트가 아니라면 나가기 버튼이 보여지며 나가기 버튼 클릭 시에 그룹 채팅방 컬렉션에 저장된 참여한 사용자 목록에서 해당 사용자 정보가 사라지도록 구성을 해 줄 생각이다. 추가로 그룹 채팅방에 이미 참여한 사용자라면, 초대가 전송되지 않거나 초대 항목에서 보이지 않는쪽으로 내용 수정을 한 번 해보거나, 다른 좋은 방법이 있는지 생각하고 이에 대한 처리를 해 줘야 할 것 같다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 그룹 채팅방을 호스트만 삭제할 수 있도록 해야 하고, 그룹 채팅방에 참여한 다른 사용자는 그룹 채팅방 삭제가 아닌, 나가기 버튼이 보여져야 하며 수정 버튼은 보이지 않도록 수정 필요

- 새로운 메시지 추가되었을 때 알림 뜨는 기능 (추가하긴 했으나, 미완성)

- 친구 관련된 내용에서 코드 정리 필요 (코드를 깔끔하게 보이도록 수정 필요)

- 그룹 채팅방에서 채팅 메시지가 추가되면 전역적으로 알 수 있도록 알림이 떠야 하고, 그 알림 관리를 소켓 Zustand에서 할 수 있도록 구성 필요

- 그룹 채팅방 초대하고 알림을 전송하는 기능에서, 로그인한 사용자가 아닌 친구에게 보내는 그런 구조로 작동되도록 수정이 필요 (비로그인 상태여도 상관이 없음 단순하게 친구한테 친구 요청하면 알림 메시지가 전달되어야 함)

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
