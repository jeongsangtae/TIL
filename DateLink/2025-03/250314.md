# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 그룹 채팅방 나가기 로직 추가 (프론트엔드, 백엔드) 및 새로운 메시지 이벤트 소켓 로직 수정
  - 그룹 채팅방을 생성한 사용자가 아닌, 참여한 사용자는 나가기 버튼으로 해당 그룹 채팅방을 목록에 지우고 나갈 수 있도록 그룹 채팅방 나가기와 관련된 로직을 추가해 주었고, 새로운 메시지 이벤트 소켓 내용에서 사용중인 중복 로직을 이전 코드로 변경해 테스트
  - 백엔드
    - group-chat-routes
      - 여러 라우터에 주석을 추가해 어떤 라우터인지 알 수 있도록 구분
      - 그룹 채팅방 나가기 DELETE 라우터 추가
        - 로그인한 사용자 정보를 불러오도록 구성
          - 불러온 사용자 정보가 유효한지 확인하는 조건문 포함
        - URL 파라미터로 전달된 그룹 채팅방 \_id를 roomId에 저장
          - new ObjectId를 사용해 변환
        - groupChat 컬렉션에서 \_id와 roomId를 비교해 일치하는 그룹 채팅방을 찾도록 구성
          - 찾은 그룹 채팅방이 존재하는지 확인하는 조건문 포함
        - users 배열에서 로그인한 사용자 \_id 제거
          - 찾은 그룹 채팅방의 users 배열에 filter를 사용해 users 배열에 저장된 \_id들과 로그인한 사용자 \_id를 비교해 일치하지 않는 항목을 남기고 나머지 제외시킴
        - 로그인한 사용자 \_id를 제외한 나머지 유저들만 users 배열에 저장되도록 업데이트하는 내용 추가
          - groupChats 컬렉션에서 \_id 값이 roomId와 일치하는 문서를 찾도록 구성
          - $set 연산자를 통해 users 배열을 filter로 제외시킨 값으로 업데이트
        - 정상적으로 모든 처리가 완료되면, 성공 메시지를 프론트엔드로 전달
          - 중간에 오류 발생 시에 오류 메시지 출력
  - 프론트엔드
    - chatStore
      - newMessage 액션 수정
        - 새로운 메시지 중복 방지 코드를 주석처리
        - 이전에 사용하던 실시간 반영 코드를 불러와 추가
        - 기존 메시지와 새로운 메시지가 중복되지 않도록 처리하는 코드가 굳이 필요하지 않을 것 같아서 변경
        - socket.off로 기존 이벤트 리스너를 제거하면 중복 방지가 충분히 되는 것으로 확인
        - 해당 내용은 별도로 정리 필요
    - groupChatStore
      - leaveGroupChat 타입 정의 추가
        - 비동기 함수로 타입 정의
        - 매개변수로 넘어오는 \_id는 string으로 정의
      - leaveGroupChat 액션 추가
        - fetch 함수 추가
          - API 경로에 \_id를 포함시켜서 전달
          - DELETE 메서드로 구성
          - 올바른 응답인지 확인하는 조건부 추가
        - 실시간 반영하는 내용 추가
          - groupChats 상태를 불러오고, filter를 사용해 그룹 채팅방 \_id와 매개변수로 넘어온 \_id가 일치하지 않는 항목만 남기고 나머지는 제외시키도록 구성
          - filter로 인해, 일치하지 않는 항목만 남기고, 일치하는 항목은 걸러내서 나가기 버튼을 클릭한 항목은 제외되어서 나머지 그룹 채팅방 목록만 보여지게 됨
        - set을 통해 groupChats 상태를 업데이트
          - filter로 정리된 내용을 넣어서 groupChats 상태를 업데이트
      - getGroupChatInvites 액션 수정
        - 소켓 관련 이벤트 내용에서 socket.off를 추가해 기존 이벤트 리스너를 제거 후 재등록 하도록 수정
          - 이벤트 리스너 중복 방지를 위해 socket.off를 추가
          - socket.off가 없을 경우, 이벤트 리스너 중복으로 인해 그룹 채팅방을 나가고 다시 그룹 채팅방 초대를 받을 경우, 중복된 그룹 채팅방 초대 메시지가 여러개 전달되는 오류 발생
          - 백엔드에서는 하나의 데이터만 저장되지만, 프론트엔드에서 여러 개의 중복된 그룹 채팅방 초대 메시지가 전달되는 오류가 생기므로, 새로운 메시지에서 구성한 것과 마찬가지로 socket.off를 추가해 이벤트 리스너 중복을 방지
    - GroupChats
      - GroupChat에 hostId를 props로 전달하도록 구성
    - GroupChat
      - useAuthStore를 불러오고, userInfo를 사용할 수 있도록 구성
      - useGroupChatStore에서 leaveGroupChat 액션을 추가로 불러오도록 구성
      - groupChatLeaveHandler 함수 추가
        - 비동기 함수로 타입 정의
        - leaveGroupChat 액션을 구성하고, \_id 내용을 전달
        - navigate를 추가해서 leaveGroupChat 액션이 작동된 후에 홈으로 이동되도록 구성
      - JSX 코드 수정
        - 호스트 ID와 로그인한 사용자의 \_id를 확인하고, 일치하는 경우에는 수정과 삭제 버튼이 보여지고, 일치하지 않는 경우 나가기 버튼이 보여지도록 수정
        - 나가기 버튼에 onClick을 추가해 groupChatLeaveHandler 함수를 구성
    - types
      - GroupChatData 타입 정의 수정
        - hostId 속성을 추가하고 string으로 타입 정의
  - 그룹 채팅방 나가기 로직을 구성하고 테스트한 결과, 구성 초기에는 이벤트 리스너 중복 오류가 발생했었지만 현재는 문제없이 나가기 로직이 작동되는 것을 확인했고, 새로운 메시지 이벤트 소켓 내용에서는 이전에 사용하던 코드로 변경하고 테스트를 진행한 결과, 수정 전과 마찬가지로 이벤트 리스너 중복이 발생하지 않는 것을 확인할 수 있었다.
    - 이벤스 리스너 중복 관련된 문제는 서버에서 중복된 메시지가 저장되지 않는 경우, socket.off로 충분하다고 생각되며, 서버에서 동일한 메시지가 여러 번 전송되는 경우 some 같은 중복 검사 로직을 구성해야 할 것 같음
    - 현재는 서버에서 동일한 메시지는 저장되지 않고 프론트엔드에서 출력만 중복되는 문제가 발생했기 때문에 복잡한 로직없이 socket.off로 해결을 하면 될 것 같고, 그룹 채팅방 삭제에서 소켓 관련 구성을 추가하면 비슷한 오류가 생길 수 있는데 이 떄도 socekt.off를 추가해 오류 해결을 해야 할 것 같다.
    - 그룹 채팅방 초대 메시지를 중복으로 여러번 보낼 수 있는 문제에 대해서는 어떤 방법으로 처리를 할 지 생각을 좀 해 봐야 하는데, 현재 그룹 채팅방 초대 메시지를 여러번 중복으로 보내고 수락을 여러번 클릭해도 그룹 채팅방이 중복으로 생기지는 않기 때문에, 메시지 관련해서만 어떻게 처리할 지 생각을 해 봐야 함
    - 그룹 채팅방 삭제 관련해서 소켓을 구성하고 테스트도 진행해 봐야 함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/8d79a24b6b03ff68c8c1ad817c4fa90268c85241)

# 오늘 느낀 점

- 그룹 채팅방을 생성한 사용자에게만 수정 또는 삭제 버튼이 보여지고, 참여한 일반 사용자는 나가기 버튼이 보이도록 조건부를 추가해 주었고, 나가기 버튼 클릭 시에 해당 그룹 채팅방 참여자 목록에서 사용자 \_id 정보가 사라지도록 구성을 해 주었다. 나가기 기능을 테스트하던 중간에 이벤트 리스너 중복 관련 문제가 발생했는데, 해당 오류는 새로운 메시지를 추가할 때 동일하게 발생했던 오류 예시가 있어서 쉽게 해결이 가능했으며, 해당 오류에 대해 수정을 하면서 테스트한 결과, 새로운 메시지 이벤트 소켓 로직도 이전보다 간결하게 구성할 수 있게 되었다고 생각이 된다. 그룹 채팅방 초대를 중복으로 보내고 수락 버튼을 클릭하면, 백엔드에서는 이미 중복 관련 처리가 되고 있기 때문에 그룹 채팅방이 중복으로 생성되지는 않지만, 초대 메시지는 중복으로 여러번 전송되어 UX 부분에서 불편할 수 있기 때문에 이에 대해 어떤 방식으로 처리하는 것이 좋을 지 생각을 해 봐야 하며, 그룹 채팅방 삭제와 관련된 실시간 반영은 추가하지 못한 상태라서 이 내용 또한 빠르게 처리를 해 줘야 한다. 추가로, 그룹 채팅방을 나간 사용자가 있을 경우, 해당 그룹 채팅방의 사용자 목록이 실시간으로 업데이트되도록 하는 내용도 고려를 해 봐야 하고, 오늘 발생했던 오류에 대해 다시 정리를 해서 확실하게 짚고 가야 할 것 같다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 그룹 채팅방 초대 메시지 중복에 관련된 내용 처리

- 그룹 채팅방 삭제 시에 실시간 반영되는 로직

- 새로운 메시지 추가되었을 때 알림 뜨는 기능 (추가하긴 했으나, 미완성)

- 친구 관련된 내용에서 코드 정리 필요 (코드를 깔끔하게 보이도록 수정 필요)

- 그룹 채팅방에서 채팅 메시지가 추가되면 전역적으로 알 수 있도록 알림이 떠야 하고, 그 알림 관리를 소켓 Zustand에서 할 수 있도록 구성 필요

- 그룹 채팅방 초대하고 알림을 전송하는 기능에서, 로그인한 사용자가 아닌 친구에게 보내는 그런 구조로 작동되도록 수정이 필요 (비로그인 상태여도 상관이 없음 단순하게 친구한테 친구 요청하면 알림 메시지가 전달되어야 함)

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
