# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 그룹 채팅방 나가기 라우터 로직 수정 (그룹 채팅방 초대 메시지 삭제, 소켓 관련 내용 추가) 및 그룹 채팅방 사용자 목록 실시간 반영 추가
  - 그룹 채팅방에 참여한 사용자에게 그룹 채팅방 초대 메시지가 전송되어 있는 상태에서 나가기 버튼을 통해 그룹 채팅방을 나가면 그룹 채팅방 초대 메시지가 삭제되지 않고 그대로 남아 있는 상태로 그룹 채팅방 이동이 가능하기 때문에 그룹 채팅방 나가기 버튼 클릭 시에 그룹 채팅방 초대 메시지도 함께 사라지도록 수정하고, 사용자가 그룹 채팅방을 나갔을 경우 그룹 채팅방에 보여지는 사용자 목록이 실시간 반영되어 나간 사용자를 제외하고 보여지도록 구성을 추가
  - 백엔드
    - group-chat-routes
      - 그룹 채팅방을 나가는 DELETE 라우터 수정
        - 그룹 채팅방을 나갈 때 해당 그룹 채팅방과 관련된 초대 메시지를 모두 삭제하도록 구성
          - 추가 테스트 결과, 오류가 있는 것을 확인 추가 수정 필요
        - Socket.io 및 onlineUsers Map을 가져오도록 구성 추가
        - 그룹 채팅방에 참여하고 로그인한 사용자들을 대상으로 이벤트 리스너를 실행시키도록 구성
          - 찾은 그룹 채팅방 users 배열에 filter를 사용해 로그인한 사용자 \_id를 제거하고 남은 내용에 현재 로그인 중인 사용자 목록 \_id와 일치하는 내용을 찾도록 구성
            - 앞에서 이미 `groupChat.users.filter`를 통해 로그인한 사용자 \_id를 제외한 사용자 목록 배열과 현재 로그인 중인 사용자 목록 배열의 \_id 내용들을 비교해 일치하는 사용자들을 찾는 내용
          - 찾은 내용이 유효할 때, gorupChatLeave 이벤트 리스너에 로그인한 사용자 \_id를 전송
          - 그룹 채팅방 나가기 버튼을 클릭한 로그인한 사용자 \_id를 전달하도록 구성한 내용
  - 프론트엔드
    - groupChatStore
      - getGroupChatUsers 액션 수정
        - socket 관련 내용을 불러오고 사용할 수 있도록 구성
        - socket.off를 추가해 이벤트 리스너 중복 실행을 방지
        - socket.on 내용 추가
          - 백엔드 groupChatLeave 이벤트 리스너와 연결
          - groupChatUsers에 filter를 사용해 그룹 채팅방에 참여한 사용자 목록 \_id와 이벤트 리스너로 넘어온 나간 사용자 \_id를 비교하고, 일치하지 않는 항목만 남겨서 보여지도록 구성
          - 일치하는 사용자는 걸러내서 화면에서 보이지 않게 됨
  - 그룹 채팅방을 나갈 때 전송받은 그룹 채팅방 초대 메시지가 삭제되도록 구성한 로직이 문제없이 작동되는 것을 확인했고, 다른 사용자가 그룹 채팅방을 나가면 그룹 채팅방에 남아있는 사용자 화면에 출력되는 사용자 목록이 실시간으로 업데이트되어 나간 사용자 닉네임이 사라지는 것을 확인할 수 있었다.
    - 그룹 채팅방을 나갈 때 해당 그룹 채팅방과 관련된 초대 메시지를 모두 삭제하도록 구성해서, 다른 사용자에게 보낸 초대 메시지까지 모두 삭제되고 있기 때문에 추가 수정이 필요함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/f890115d62f251f343cc2eb26d6ac24ed27b6295)

<br />

- 그룹 채팅방 사용자 목록 실시간 반영 수정 (사용자 추가 관련된 내용)
  - 그룹 채팅방에 새로운 사용자가 추가되면 사용자 목록이 실시간으로 업데이트되어 해당 사용자 닉네임이 보이도록 그룹 채팅방 사용자 목록 관련 실시간 반영 내용을 수정
  - 백엔드
    - group-chat-routes
      - 그룹 채팅방 초대 수락하는 POST 라우터 수정
        - req.body로 전달받은 groupChatId로 그룹 채팅방을 찾는 내용 추가
          - 찾은 그룹 채팅방이 유효한지 확인하는 조건문 포함
        - Socket.io 및 onlineUsers Map을 가져오도록 구성 추가
        - 그룹 채팅방에 참여하고 로그인한 사용자들을 대상으로 이벤트 리스너를 실행시키도록 구성
          - 찾은 그룹 채팅방 users 배열에 저장된 사용자 \_id 내용을 가져와 로그인한 사용자 목록 \_id와 일치하는 내용을 찾음
          - 찾은 내용이 유효할 때, acceptGroupChat 이벤트 리스너에 로그인한 사용자 정보를 전송
            - \_id, email, nickname, username 정보를 전달
          - 그룹 채팅방 초대 수락 버튼을 클릭한 로그인한 사용자 정보를 전달하도록 구성한 내용
  - 프론트엔드
    - groupChatStore
      - getGroupChatUsers 액션 수정
        - socket 관련 내용을 불러오고 사용할 수 있도록 구성
        - socket.off를 추가해 이벤트 리스너 중복 실행을 방지
        - socket.on 내용 추가
          - 백엔드 acceptGroupChat 이벤트 리스너와 연결
          - some을 사용해 중복 방지를 하고, 스프레드 연산자를 사용한 실시간 반영 로직
            - groupChatUsers에 some을 사용해 그룹 채팅방에 참여한 사용자 목록 \_id와 이벤트 리스너로 넘어온 사용자 \_id 정보를 확인
              - 일치할 경우, 기존 그룹 채팅방 사용자 목록을 출력
              - 일치하지 않을 경우, 기존 그룹 채팅방 사용자 목록에 이벤트 리스너로 넘어온 사용자 정보를 추가
          - concat을 사용해 실시간 반영하는 로직
            - groupChatUsers에 concat을 사용해 이벤트 리스너로 넘어온 사용자 정보를 추가
            - 중복 방지 로직이 없고 단순히 concat을 사용해 사용자 정보를 추가하는 방식으로, 로직이 단순하지만 키 관련 오류가 없음
            - concat 자체는 단순히 배열을 합치는 기능만 수행할 뿐이지만, 리액트가 내부적으로 상태 업데이트를 비교할 때 배열의 참조값이 달라지기 때문에 오류가 발생하지 않는 것처럼 보이므로, concat 역시 중복된 데이터를 추가할 가능성은 존재함
          - concat을 사용하고 중복 방지 내용을 추가해 실시간 반영하는 로직
            - groupChatUsers에 find를 사용해 그룹 채팅방에 참여한 사용자 목록 \_id와 이벤트 리스너로 넘어온 사용자 \_id 정보를 확인
              - 일치할 경우, 기존 그룹 채팅방 사용자 목록을 출력
              - 일치하지 않을 경우, 기존 그룹 채팅방 사용자 목록에 concat을 사용해 이벤트 리스너로 넘어온 사용자 정보를 추가
          - 그룹 채팅방에 새롭게 참여한 사용자 닉네임이 사용자 목록에 보여지게 됨
            - 현재는 스프레드 연산자를 사용한 실시간 반영 로직만 활성화해 놓은 상태로, concat을 사용한 로직은 주석 처리 상태
  - 그룹 채팅방에 새로운 사용자가 들어오면 사용자 목록이 실시간으로 업데이트되도록 내용을 구성하고 테스트한 결과, 문제없이 반영되어 새롭게 들어온 사용자의 닉네임이 화면에 출력되는 것을 확인할 수 있었다.
    - 그룹 채팅방 삭제 시에, 삭제되는 그룹 채팅방에 남아있는 사용자는 홈으로 이동되지 않는 문제 때문에, UX 부분에서 불편함을 느낄 수 있고 추가 문제가 생길 수 있으므로 수정을 해 줘야 함
    - 그룹 채팅방에서 새로운 메시지가 추가되었을 때 알림 넘어오는 기능에 대한 내용 수정이 필요함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/f6a9460247e1d95f5fa58ef05bf016eb775df1b7)

# 오늘 느낀 점

- 그룹 채팅방에 참여한 상태에서 그룹 채팅방 초대 메시지가 추가로 있을 경우, 그룹 채팅방 나가기를 실행하면 해당 그룹 채팅방 초대 메시지가 삭제되어 보이지 않도록 구성을 해 주었는데, 이 내용 구성에 실수가 있어서 추가 수정이 필요하다. 그룹 채팅방에 새로운 사용자가 추가되거나 혹은 나갈 경우, 그룹 채팅방에 보여지는 사용자 목록이 실시간으로 변경되어 보여지도록 내용을 추가했는데, 현재는 잘 적용되어 실시간 반영되는 것을 확인했다. 그룹 채팅방을 호스트가 삭제할 때, 제거되는 그룹 채팅방에 참여한 사용자가 해당 그룹 채팅방 세부 페이지에 있을 경우, 홈으로 이동되지 않고 그대로 삭제된 그룹 채팅방에 남아있기 때문에 이에 대한 처리를 해 주면 더 깔끔한 UX를 제공할 수 있다고 생각되어 수정해 줘야 한다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 새로운 메시지 추가되었을 때 알림 뜨는 기능 (추가하긴 했으나, 미완성)

- 친구 관련된 내용에서 코드 정리 필요 (코드를 깔끔하게 보이도록 수정 필요)

- 그룹 채팅방에서 채팅 메시지가 추가되면 전역적으로 알 수 있도록 알림이 떠야 하고, 그 알림 관리를 소켓 Zustand에서 할 수 있도록 구성 필요

- 그룹 채팅방 초대하고 알림을 전송하는 기능에서, 로그인한 사용자가 아닌 친구에게 보내는 그런 구조로 작동되도록 수정이 필요 (비로그인 상태여도 상관이 없음 단순하게 친구한테 친구 요청하면 알림 메시지가 전달되어야 함)

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
