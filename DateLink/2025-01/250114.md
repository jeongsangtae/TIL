# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- Float Chat 프로젝트 구성중 발생한 에러 내용 추가 (localStorage.getItem에 사용한 parseInt 타입 정의 에러)
  - localStorage.getItem에 사용한 parseInt 타입 정의 에러와 관련된 내용을 정리
    - 발생한 에러에 대한 내용과 원인을 추가
    - 에러를 발생시킨 코드 내용을 추가하고, 해결한 방법과 코드를 함께 추가
  - [코드 내용](https://github.com/jeongsangtae/TIL/commit/ee226b79d7879605e548cd0f9136ff837f26dbeb)

<br />

- JWT 토큰 만료시간 수정 및 리프레시 토큰 갱신 관련 내용 추가
  - 테스트를 위해 JWT 토큰 만료시간을 수정해 주었고, 액세스 토큰이 갱신될 때 리프레시 토큰도 함께 갱신되도록 관련 내용을 추가
  - 백엔드
    - jwt-auth
      - 리프레시 토큰 내용을 관리하는 함수 내용 수정
        - 액세스 토큰 만료 시간을 5분으로 수정
        - 액세스 토큰 갱신시에 리프레시 토큰도 함께 갱신하도록 구성 추가
          - \_id, 이름, 이메일
          - 리프레시 토큰 키
          - 만료시간 15분으로 구성
        - 쿠키에 저장되는 액세스 토큰 만료 시간 5분으로 설정해 추가
        - 쿠키에 저장되는 리프레시 토큰 내용 추가
          - secure, httpOnly, sameSite 내용 추가
          - 만료 시간은 15분으로 설정
        - 토큰 갱신 메시지에 리프레시 토큰 재생성 내용도 추가
    - user-routes
      - 테스트를 위해 만료시간을 수정
      - 액세스 토큰 5분, 리프레시 토큰 15분으로 변경
  - 프론트엔드
    - Login
      - 로그인하면 콘솔에 JWT 토큰 내용이 출력되는 console.log 삭제
    - authStore
      - 현재 시간, 만료 시간, 리프레시 토큰 만료 시간 내용의 시간이 정확히 보여지도록 console.log 수정 및 분리
      - 테스트를 위해 인터벌 간격을 1분으로 수정
        - 만료 시간은 5분으로 수정
  - 액세스 토큰이 갱신될 때 리프레시 토큰도 갱신이 되도록 구성하고 테스트한 결과, 쿠키에 저장된 리프레시 토큰은 갱신이 되지만 로컬 스토리지에 저장된 리프레시 토큰 만료시간은 갱신이 되지 않아서 정상적으로 로그인 유지가 되지 않고 로그아웃 되는 것을 확인했기 때문에 추가로 수정이 필요하다.
    - 리프레시 토큰이 갱신되면 새로운 만료 시간을 가지게 되는데, 그 만료 시간이 쿠키에서만 갱신되고 로컬 스토리지에서는 갱신되지 않아서 정상적으로 로그인 유지가 되지 않고 로그아웃이 되어버리는데 이 문제는 리프레시 토큰 만료시간 액션이 실행되도록 수정하면 해결될 것으로 예상됨
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/0fcbc8ab47e9827992d961c0dec281e0a2835130)

<br />

- 로컬 스토리지에 저장된 refreshTokenExp 항목을 갱신하는 내용 추가 (갱신 에러 수정)
  - 리프레시 토큰 만료시간을 쿠키에서만 갱신하고 로컬 스토리지에서는 갱신하지 않아서 로그인 유지가 되지 않고 로그아웃이 되어버리기 때문에 이와 관련된 문제를 해결하기 위해 리프레시 토큰 액션이 실행될 때 리프레시 토큰 만료 시간 액션이 함께 실행되도록 수정
  - 프론트엔드
    - authStore
      - refreshToken 액션 내용이 실행될 때, refreshTokenExp 액션이 실행되도록 구성
  - 리프레시 토큰 액션이 실행될 때 리프레시 토큰 만료시간 액션도 함께 실행되도록 구성하고 테스트한 결과, 쿠키에 저장된 리프레시 토큰이 갱신될 때 만료시간도 함께 갱신되며, 로컬 스토리지에 저장된 refreshTokenExp 항목의 내용 또한 갱신되어 쿠키에 저장된 리프레시 토큰 만료시간과 일치하는 것을 확인할 수 있었다.
    - 리프레시 토큰 만료시간 액션이 함께 실행되도록 수정해 주면서, 브라우저를 켜놓은 상태에서는 로그인 유지가 문제없이 지속되는 것을 확인
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/edb4be918e43768f58ee18d9dd3bb4c9391d41d2)

# 오늘 느낀 점

- 에러 관련 내용을 정리해 주고, 액세스 토큰 갱신 시에 리프레시 토큰이 함께 갱신되도록 구성해 준 결과, 브라우저를 켜놓은 상태에서는 로그아웃이 되지 않으며 로그인 상태가 계속 지속되는 것을 확인할 수 있었다. 하지만 이 외에 여러 오류들을 발견했는데 그 오류들을 모두 수정해야 내가 생각한 로그인 유지 및 갱신 동작이 이루어지기 때문에 반드시 처리를 해 줘야 하며, 발견한 오류는 아래에 따로 정리해 주었다.

- 첫 번째 오류는 로그아웃 처리가 되었을 경우 인터벌이 종료되어야 하는 것이 맞지만 여전히 인터벌이 작동하는 문제가 있기 때문에 수정이 필요하다. 액세스 토큰이 유효하는 동안에 다시 페이지에 접속하면 그대로 로그인이 유지되어 있고 인터벌은 계속 작동해 만료 시간을 확인하고 액세스 토큰과 리프레시 토큰을 갱신하는 것을 확인했기 때문에, 사용자가 직접 로그아웃을 했음에도 계속 실행되는 인터벌에 대한 처리와 토큰 만료로 로그아웃 처리가 된 후에도 실행되는 인터벌에 대한 내용만 수정해 주면 될 것 같다.

- 두 번째 오류는 액세스 토큰 만료 시간이 지난 후에 페이지에 다시 접속하면 리프레시 토큰 만료 시간이 남아있음에도 로그아웃이 되어있기 때문에 이 부분에 대한 수정이 필요한데, 아마도 로컬 스토리지에 저장하는 expirationTime 항목이 액세스 토큰 만료 시간에 맞춰서 구성되어 있기 때문에 이 오류가 발생한 것으로 예상이 되며, 리프레시 토큰 만료 시간으로 설정하면 해결될 것 같다.

- 세 번째 오류는 리프레시 토큰이 만료되어 로그아웃 처리가 된 후에 페이지에 접속하면 나중에 추가할 다크 모드 항목을 제외하고 로컬 스토리지의 모든 항목과 쿠키가 모두 깔끔하게 초기화 되어야 하지만, 현재는 쿠키만 초기화되고 로컬 스토리지 항목은 남아있기 때문에 이에 대한 수정이 필요하다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
