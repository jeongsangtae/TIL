# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- Zustand에 renewToken 액션 추가, 사용 및 사이드바 컴포넌트에 구성된 useEffect 수정
  - Zustand에 사용자 인증 및 토큰을 갱신하는 액션 내용을 추가하고, 사이드바 컴포넌트에서는 Zustand에 새롭게 추가한 액션 내용이 useEffect를 통해 실행되도록 구성
  - 프론트엔드
    - SideBar
      - Zustand에서 renewToken, refreshTokenExp 액션 추가로 가져오도록 수정
      - useEffect 내용 수정
        - 의존성 배열로 isLoggedIn 상태 확인
        - isLoggedIn 상태를 if문으로 확인하고, true일 때 refreshTokenExp, renewToken 액션이 비동기로 실행되도록 구성
        - refreshTokenExp 액션 내용을 추가한 이유는 renewToken 액션만 사용하면 리프레쉬 토큰 만료 시간을 최신 데이터로 업데이트하지 못해서 로그인된 후, 바로 로그아웃 되어 버리는 문제가 발생하기에 사용
    - authStore
      - renewToken 액션에 대한 타입 정의 추가
        - 기본 함수 타입으로 정의
      - refreshToken 액션에 대한 타입 정의 추가
        - 비동기 함수 타입으로 정의
      - renewToken 액션 추가
        - checkTokenExpiration 함수
          - 현재 시간을 확인하는 변수
          - 로컬 스토리지에 저장된 expirationTime 항목을 가져오는 변수
            - localStorage.getItem는 항상 string 또는 null을 반환하는데, TS에서 null에 대해 parseInt를 사용하면 타입 오류가 발생하므로, null 처리를 위해 기본값을 0으로 제공해 에러가 발생하지 않도록 처리
          - 로컬 스토리지에 저장된 refreshTokenExp 항목을 가져오는 변수
            - 마찬가지로 기본값을 0으로 제공해 에러가 발생하지 않도록 처리
          - 토큰 만료 시간을 확인하고 갱신 및 로그아웃 시키는 if문
            - 현재 시간이 액세스 토큰 만료 시간 이상이고, 리프레시 토큰의 만료 시간보다 적다면 액세스 토큰을 갱신하고 로그인을 유지
            - 리프레시 토큰이 만료된 경우 로그아웃 처리를 수행
          - 그 외에 console.log를 추가해 정상적으로 시간이 나오는지 확인
        - checkTokenOnLoad 함수
          - 페이지 로드 시 토큰 만료 여부를 확인하는 함수
          - 로컬 스토리지에 저장된 isLoggedIn 항목을 가져와 확인하고, 존재하는 경우 checkTokenExpiration 함수를 실행하도록 구성
        - 인터벌 if문
          - 로그인 유무를 확인해 로그인 상태일 경우, verifyUser 액션을 실행하고 일정 시간마다 인터벌을 실행해 토큰 만료를 확인하도록 구성
            - 컴포넌트 언마운트 시 인터벌이 정리되도록 구성
            - 현재는 테스트를 위해 5분 간격으로 인터벌이 실행되도록 구성
          - 인터벌 관련 에러가 발생하면 logout 액션을 실행시켜 로그아웃 하도록 구성
          - 그 외에 console.log를 추가해 정상적으로 인터벌 내용이 작동하는지 확인
  - 추가한 renewToken 액션 내용이 문제없이 작동하는지 확인해 본 결과, 인터벌이 5분 간격으로 작동하며 액세스 토큰 만료 여부를 확인하고, 액세스 토큰이 만료된 경우 리프레시 토큰을 확인해 유효한 경우 액세스 토큰을 다시 갱신하고, 만약 리프레시 토큰이 만료된 경우 바로 로그아웃으로 처리하는 것을 확인할 수 있었다.
    - 한가지 문제점으로 로그아웃 처리가 된 후에 인터벌이 멈춰야 하는데 계속 작동하는 것을 확인했기 때문에 이 부분은 수정해야 함
    - 위 상황은 브라우저를 계속 켜놓은 상태에서 컴포넌트가 언마운트되지 않아서 계속 작동한 것 같은데, 브라우저를 닫았을 경우에는 어떤식으로 작동하는지 추가 확인 필요
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/959b48f02eccc374c113559138a80d21290eb505)

# 오늘 느낀 점

- Zustand에 renewToken 액션을 추가하고 사이드바 컴포넌트의 useEffect에 추가해 테스트한 결과, 로그인 유지와 토큰 갱신 그리고 만료되었을 경우 로그아웃 시키는 로직이 정상적으로 작동하는 것을 확인할 수 있었다. 토큰 만료로 로그아웃 처리가 되면 인터벌도 멈춰야 하는데, 컴포넌트가 언마운트되지 않는 이상 인터벌이 주기적으로 계속 작동하는 문제를 발견 했고, 브라우저를 닫고 어떤식으로 작동하는지 확인해 보지 못했기 때문에 이 부분도 추가 테스트를 통해 확인해 봐야 한다. 추가로 로그인하고 브라우저를 켜놓은 상태로 토큰이 만료되었을 때 실시간 적용이 되는지 다시 한 번 확인해 봐야 한다.

- 이전 프로젝트에서는 액세스 토큰 갱신 시에 리프레시 토큰이 함께 갱신되도록 구성하지 않았지만, 이번 프로젝트에서는 액세스 토큰 갱신 시에 리프레시 토큰도 함께 갱신되도록 구성을 해야 하기 때문에 리프레시 토큰 관련 백엔드 로직에서, 액세스 토큰뿐만 아니라 리프레시 토큰도 함께 갱신되도록 로직을 수정해 줘야 한다. 수정한 후에 액세스 토큰 갱신 시에 리프레시 토큰도 함께 갱신되는지 확인이 필요하고, 갱신되는 사이에 로그인 유지나 인터벌 동작에 문제가 없는지 확인도 필요하다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
