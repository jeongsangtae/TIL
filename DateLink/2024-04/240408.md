# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 로컬 스토리지 데이터 초기화 문제 처리
    - 로그인하고 새로고침을 했을 때, 계속 로컬 스토리지가 초기화되며 로그인이 풀리는 문제를 해결하기 위해서 코드를 수정해주었다.
    - 프론트엔드 구성
      - if문과 else if문에서 refreshTokenExp에 대한 처리를 추가
      - useEffect에 의존성 배열을 추가
      - refreshTokenHandler 함수에서 현재 시간을 추가해서 expirationTime이 현재 시간에 +1시간이 되도록 구성
    - 테스트 결과, if문과 else if문에서 refreshTokenExp에 관한 처리를 추가해주면서 일단은 새로고침해도 로그아웃이 되지 않는 것을 확인했다.
      - 하지만, 이 방법은 임시방편으로 근본적인 해결을 하지 못했기 때문에 추가 수정이 필요함
      - 근본적인 문제는 refreshTokenExp이 null로 표시가 되면서 else if문이 작동되어 버린다는 것인데, 이 문제를 해결해줘야 정상적으로 액세스 토큰이 실시간 갱신되며 로그인이 풀리지않고 유지될 수 있게 된다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/f85f51ff6d5a471a1b255b889948df9a8ffd2845)

  <br />

  - 리프레쉬 토큰 만료 시간을 로컬 스토리지에 저장, 밀리초 단위를 초 단위로 변경해주고, 테스트를 위해서 만료 시간들을 짧게 구성 등 내용 변경 (액세스 토큰 실시간 갱신 성공)
    - 임시 방편으로 로그아웃이 되는 것을 막아놓긴 했지만, 근본적인 해결은 하지 못했기 때문에 이 부분을 고쳐주기 위해서, 리프레쉬 토큰 만료 시간을 로컬 스토리지에 저장하고, if문과 else if문이 정상 작동하도록 초 단위로 저장되도록 해주고, 만료 시간을 변경해서 실시간 갱신이 되는지 확인해주었다.
    - 백엔드 구성
      - 액세스 토큰 만료 시간을 1시간에서 5분으로 변경
      - 리프레쉬 토큰 만료 시간을 12시간에서 30분으로 변경
    - 프론트엔드 구성
      - 리프레쉬 만료 시간 관련 useState를 주석 처리
        - 대신, 리프레쉬 만료 시간을 로컬 스토리지에 저장되도록 구성
      - useEffect, loginHandler 등에서 밀리 초 단위로 저장되고 있던 부분을 초 단위로 저장되도록 변경
        - 백엔드에서 넘어오는 리프레쉬 토큰 만료 시간은 초 단위로 저장이 되어 넘어오기 때문에, 현재 시간과 로컬 스토리지에 저장된 로그인 유무 만료 시간은 밀리 초 단위에서 초 단위로 변경
      - useEffect에서 로컬 스토리지에 저장된 내용의 데이터를 가져오고 parseInt를 사용해서 변환해주고 조건문이 정상적으로 작동하도록 구성
      - 로컬 스토리지에 저장되는 만료 시간들을 소수점 아래를 올려서 시간 단위가 맞도록 구성
      - 로그아웃 시 로그인 유무, 만료 시간 외에 리프레쉬 토큰 만료 시간 내역도 함께 삭제되도록 구성
    - 테스트 결과, 액세스 토큰이 정상적으로 갱신되기 때문에 사용자 정보도 남아있고, 로그인 관련 로컬 스토리지도 갱신이 되기 떄문에 로그인 유지도 잘 되고 있다.
      - 리프레쉬 토큰 만료 시간을 useState에 저장하면 새로고침 시에 사라지게 되고, 다시 가져와서 사용하려고 해도 null이 나온 후, 나중에 제대로 된 값이 들어오기 때문에 이 문제를 해결하기 위해서 로컬 스토리지에 저장되어, 사라지지 않고 바로 사용
      - 밀리 초 단위에서 초 단위로 모두 변경해주면서 if문과 else if문이 정상적으로 작동하며, 리프레쉬 토큰 만료 시간이 현재 시간보다 높을 경우, 액세스 토큰이 실시간으로 갱신되고 로그인이 유지된다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/135249e31a036c6d0f8f314d5148fc77fb5d8880)

<br />

- 추가 및 해결 해야 할 내용
  - 회원가입 form에서 잘못된 입력을 제출 했을 때, session에 데이터가 저장되는데, 기존의 session 데이터에서 업데이트되는 방식이 아닌 매번 제출할 때마다 새로운 session이 추가되고 있기 때문에 백엔드 코드에서 수정이 필요하다.
    - 계속 원인을 찾아보려고 이것저것 시도해보았지만 아직 어떤 코드가 정확히 원인인지 찾지 못해서 하나씩 천천히 테스트가 필요함
    - 일단 이걸 테스트 해보기전에 먼저 정상적으로 세션 만료가 되는지 확인해보았는데 정상적으로 세션 만료가 되기 때문에, 로그인을 먼저 구성해보고 정상적으로 로그인이 되는지 확인을 해보고 안된다면, session에 저장되는 부분을 다시 확인해봐야 할 것 같다는 생각
    - 이 부분은 session을 삭제하게 되면 더 이상 신경쓰지 않아도 되지만, 현재는 session을 그냥 놔둔 상태이기 때문에 잠시 유지
  - 로그인을 유지하고 있을 때, token이 만료 시간에 가까워지면 자동으로 갱신되는 로직을 추가 해야 함
    - 대충 구성만 되어 있는 상태로, 좀 더 자세한 코드와 테스트가 필요함
  - 커스텀 Hook에 대한 고려 및 세션 제거 작업
    - 세션과 연동이 가능한 부분이 있는지도 테스트가 필요함
      - 불가능, 세션이나 jwt 토큰 중 하나만 사용하는 것이 좋다.
      - 세션을 삭제하는 작업을 아직 하지 않아서 해줘야 함
    - Context API를 사용하는 것은 좋지만, 이 내용을 사용하려는 파일에서 하나하나 추가해서 사용하기 때문에 커스텀 Hook을 구성해서 재사용할 수 있도록 해줄 필요가 있음
  - 백엔드의 user-router.js에서 accessToken, login/success, profile router에서 모두 accessToken 함수 내용을 재사용하고 있는데, 굳이 3개의 router로 나눌 필요가 있는 지 확인해보고 필요가 없다면 하나로 줄여줘야 함
    - 명확하게 하기 위해서 일단은 하나로 합치지 않고, 그대로 나눠서 사용하도록 유지
    - 내용이 엄청 많은 코드로 구성된 것이 아니기 때문에 현재로서는 크게 문제 없다고 생각되어 그대로 유지
  - 액세스 토큰, 리프레시 토큰 버튼을 메인헤더에서 제거해야 함
    - 일단 주석처리해서 사용하지 않도록 변경
  - 코드 예외 처리 더 필요한 부분이 있는 지 체크해야 함
  - 메인 헤더 깜빡임 확인
    - 게시판에서 새로고침 시에는 깜빡임이 없으나, 프로필, 홈 화면에서는 메인헤더의 변경 깜빡임이 조금 있기 때문에 추가 확인 필요

# 오늘 느낀 점

- 액세스 토큰 실시간 갱신 기능이 아직 완벽하지 않아서, 수정해줘야 할 부분들이 있는데 첫 번째는 로그아웃이 된 후에도 setInterval에 의해서 계속 작동되는 useEffect 부분을 수정해줘야 한다. 계속 작동되는 useEffect로 인해서 계속 쿠키에 액세스 토큰이 남아있게 되므로 이 부분을 수정해야 한다. 두 번째는 로그인 핸들러에서 setTimeout으로 구성된 부분을 삭제하는 것도 고려를 해봐야 하는데, 이제는 useEffect에서 리프레쉬 토큰 만료 시간을 확인해서 액세스 토큰이 실시간으로 갱신되기 때문에 더 이상 로그인을 하고 일정 시간이 지난 뒤에 로컬 스토리지 내용, 로그인 유무 관련 useState, 사용자 정보 내용이 사라질 필요가 없게 되었으므로 수정해줘야 한다. 그 외에 좀 더 테스트를 해보고 문제가 되는 부분들을 추가 수정해줘야 하며, 현재 시간과 토큰 만료 시간을 좀 더 세부적으로 맞추는 작업도 해줘야 할 것 같고, 만료 시간에 맞춰 삭제되어야 하는 내용들이 조금 간격이 있는 것 같아서 이 부분도 확인해보고 수정이 가능하다면 수정을 해줘야 할 것 같다. 추가로, 테스트하기 위해서 구성해놓은 리프레쉬 토큰과 리프레쉬 토큰 EXP 버튼을 더 이상 사용하지 않기 때문에 메인헤더에서 보이지 않게 해줘야 한다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
