# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 백엔드의 리프레쉬 토큰 함수에서 액세스 토큰 재발급과 리프레쉬 토큰 만료 시간을 따로 분리해서 사용
    - 기존의 리프레쉬 토큰 함수에 액세스 토큰 재발급과 리프레쉬 토큰 만료 시간을 전달하는 코드가 함께 사용되고 있었기 때문에, 따로 분리해서 불필요한 액세스 토큰 재발급이 이루어지지 않도록 구성 변경
    - 백엔드 구성
      - jwt-auth.js에서 액세스 토큰만 재발급하는 refreshToken 함수와 리프레쉬 토큰 만료 시간만 따로 전달하는 refreshTokenExp 함수로 나눠서 구성
      - user-router.js에서 refreshTokenExp 함수를 import하고, refreshTokenExp 함수를 사용하는 라우터를 구성해서 프론트엔드와 연결되도록 구성
    - 프론트엔드 구성
      - 메인헤더에 리프레쉬 토큰의 만료 시간을 확인하는 버튼 추가
        - 해당 버튼 클릭 시, 콘솔에 리프레쉬 토큰 만료 시간이 출력된다.
        - 이 버튼은 테스트용 버튼으로, 현재 구성을 테스트하기 위해서 추가했을 뿐이며 실제 구성에는 포함되지 않는다.
      - Context API에 refreshTokenExpHandler를 추가하고, 초기 값과 value에 포함시켜서 테스트할 수 있도록 구성
    - 리프레쉬 토큰 EXP 버튼을 클릭하면 콘솔에 리프레쉬 토큰 만료 시간이 출력되는 것을 확인할 수 있었다.
      - 현재 구성된 내용을 테스트한 결과, 리프레쉬 토큰 버튼을 클릭하지 않는다면 액세스 토큰이 재발급 되지 않는 것을 확인할 수 있었다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/0d1fe09b263e9b69b2909b8d034ea0e3ed0daf7d)

  <br />

  - 액세스 토큰이 실시간으로 갱신되도록 하기 위해서, useEffect와 refreshTokenHandler 함수를 수정하고, useEffect를 하나 더 추가해서 내용을 분리
    - 액세스 토큰이 실시간으로 갱신되도록 useEffect 내용에 좀 더 상세한 if문을 구성하고 내용을 변경해주었으며, useEffect가 아닌 refreshTokenHandler 함수에서 작동되도록 일부 내용도 옮겨주고, useEffect를 하나 더 추가해서 로그인 상태와 만료 시간 관련 내용을 따로 분리해주었다.
    - 프론트엔드 구성
      - useEffect에서 refreshTokenExpHandler 함수를 실행하도록 구성
      - useEffect에서 새로운 함수인 checkTokenExpiration 함수를 추가
        - 현재 시간을 가져옴
        - 로컬 스토리지에 저장된 만료 시간 데이터를 가져옴
        - if문을 통해서 현재 시간과 만료 시간을 비교, 리프레쉬 토큰 만료 시간과 현재 시간을 비교하도록 조건 구성
        - if문이 true 일 경우, refreshTokenHandler 함수 실행 및 로그인 유지
        - if문이 false 일 경우, else if의 조건인 현재 시간과 리프레쉬 토큰 만료 시간을 확인하는 조건 실행
        - else if문이 true 일 경우, 로컬 스토리지에 저장된 로그인 유무와 만료 시간 데이터 삭제 그리고 비로그인 상태로 만듦
      - useEffect에서 checkTokenExpiration 함수가 실행되도록 구성
      - setInterval을 사용해서, checkTokenExpiration 함수가 30분 간격으로 실행되도록 구성
        - 이 부분은 테스트를 위해서 시간 간격 수정이 필요함
      - 컴포넌트 언마운트 시 인터벌 정리하기 위해서 clearInterval을 사용해서 구성
      - refreshTokenHandler 함수가 실행될 때, 액세스 토큰이 재발급되면서 로컬 스토리지에 저장된 "isLoggedIn", "expirationTime"도 다시 추가되도록 내용을 구성
      - 기존의 useEffect에서 구성된 내용인, 로그인 상태와 만료 시간 내용은 새롭게 useEffect를 하나 더 추가해서 분리
    - 아직 실시간 갱신은 테스트해보지 못했으며, 로그인과 로그아웃은 정상적으로 이루어지는 것만 확인했다.
      - 액세스 토큰과 리프레쉬 토큰의 만료 시간을 짧게 구성한 다음에 실시간 갱신 관련 내용을 테스트 해봐야 할 것 같다.
      - 현재 구성된 내용으로 로그인, 로그아웃, 새로고침은 테스트해보았는데 로그인과 로그아웃은 문제가 없지만, 로그인하고 새로고침 했을 때는 로컬 스토리지에 저장된 데이터가 사라지며 로그인이 풀리는 것을 확인했기 때문에 이 부분은 추가 수정이 필요하다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/17e8fbd39a12b959328945045eaa659aeba58380)

<br />

- 추가 및 해결 해야 할 내용
  - 회원가입 form에서 잘못된 입력을 제출 했을 때, session에 데이터가 저장되는데, 기존의 session 데이터에서 업데이트되는 방식이 아닌 매번 제출할 때마다 새로운 session이 추가되고 있기 때문에 백엔드 코드에서 수정이 필요하다.
    - 계속 원인을 찾아보려고 이것저것 시도해보았지만 아직 어떤 코드가 정확히 원인인지 찾지 못해서 하나씩 천천히 테스트가 필요함
    - 일단 이걸 테스트 해보기전에 먼저 정상적으로 세션 만료가 되는지 확인해보았는데 정상적으로 세션 만료가 되기 때문에, 로그인을 먼저 구성해보고 정상적으로 로그인이 되는지 확인을 해보고 안된다면, session에 저장되는 부분을 다시 확인해봐야 할 것 같다는 생각
    - 이 부분은 session을 삭제하게 되면 더 이상 신경쓰지 않아도 되지만, 현재는 session을 그냥 놔둔 상태이기 때문에 잠시 유지
  - 로그인을 유지하고 있을 때, token이 만료 시간에 가까워지면 자동으로 갱신되는 로직을 추가 해야 함
    - 대충 구성만 되어 있는 상태로, 좀 더 자세한 코드와 테스트가 필요함
  - 커스텀 Hook에 대한 고려 및 세션 제거 작업
    - 세션과 연동이 가능한 부분이 있는지도 테스트가 필요함
      - 불가능, 세션이나 jwt 토큰 중 하나만 사용하는 것이 좋다.
      - 세션을 삭제하는 작업을 아직 하지 않아서 해줘야 함
    - Context API를 사용하는 것은 좋지만, 이 내용을 사용하려는 파일에서 하나하나 추가해서 사용하기 때문에 커스텀 Hook을 구성해서 재사용할 수 있도록 해줄 필요가 있음
  - 백엔드의 user-router.js에서 accessToken, login/success, profile router에서 모두 accessToken 함수 내용을 재사용하고 있는데, 굳이 3개의 router로 나눌 필요가 있는 지 확인해보고 필요가 없다면 하나로 줄여줘야 함
    - 명확하게 하기 위해서 일단은 하나로 합치지 않고, 그대로 나눠서 사용하도록 유지
    - 내용이 엄청 많은 코드로 구성된 것이 아니기 때문에 현재로서는 크게 문제 없다고 생각되어 그대로 유지
  - 액세스 토큰, 리프레시 토큰 버튼을 메인헤더에서 제거해야 함
    - 일단 주석처리해서 사용하지 않도록 변경
  - 코드 예외 처리 더 필요한 부분이 있는 지 체크해야 함
  - 메인 헤더 깜빡임 확인
    - 게시판에서 새로고침 시에는 깜빡임이 없으나, 프로필, 홈 화면에서는 메인헤더의 변경 깜빡임이 조금 있기 때문에 추가 확인 필요

# 오늘 느낀 점

- 액세스 토큰과 로컬 스토리지에 저장된 내용이 실시간으로 갱신이 되도록 하기 위해서 useEffect 내용을 변경해주었는데, 아직 정확한 테스트를 해보지 못해서 이와 관련된 테스트가 필요한 상황이다. 현재 변경한 코드로 인해 로그인과 로그아웃, 새로고침 했을 때 문제가 생길만한 상황을 확인하기 위해서 테스트해본 결과, 로그인과 로그아웃은 문제가 없었지만 로그인하고 새로고침 했을 때 로컬 스토리지의 내용이 초기화되는 문제를 발견했기 때문에 이 부분을 다시 확인하고 수정을 해줘야 한다. 그래도 이제 리프레쉬 토큰이 존재하는 동안, 액세스 토큰을 갱신해서 로그인이 유지되도록 해주는 기능 구성이 어느정도 가닥이 잡힌 것 같아서, 테스트를 진행해보면서 추가로 필요한 부분을 구성하고 오류를 수정해야 할 것 같다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
