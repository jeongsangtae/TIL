# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 온라인 친구 출력하는 로직 추가
  - 전체 친구 목록과 별개로 현재 로그인 상태인 친구만 따로 출력될 수 있도록 백엔드와 프론트엔드에서 로직을 추가하고, 서로 연결해 온라인 상태의 친구 목록만 출력하도록 구성
  - 백엔드
    - friend-routes
      - 온라인 친구 목록을 조회하는 GET 라우터 추가
        - 로그인한 사용자 정보를 가져오도록 구성
          - 가져온 사용자 정보의 \_id 내용을 ObjectId 형식으로 변환
        - onlineUsers Map에서 로그인한 사용자 정보를 가져오도록 구성
        - 로그인한 사용자와 관련된 친구 목록을 불러오도록 구성
        - 온라인 상태인 친구만 필터링할 수 있도록 로직 구성
          - 불러온 친구 목록에 filter 메서드를 사용
          - requester.id 내용과 로그인한 사용자 \_id 내용이 일치하면 receiver.id에 있는 내용을 가져오고, 아닐 경우 requester.id 내용을 가져오도록 구성
          - 찾은 친구 \_id를 onlineUsers Map에 넣어서 현재 로그인 상태인 친구를 찾고 반환하도록 구성
        - 찾은 현재 로그인 상태의 친구 정보를 프론트엔드로 전달하도록 구성
  - 프론트엔드
    - friendStore
      - onlineFriends 상태 타입 정의 추가
        - Friend 타입 정의를 재사용하고, 뒤에 배열로 타입 정의
      - loadOnlineFriends 액션 타입 정의 추가
        - 비동기 함수로 타입 정의
      - onlineFriends 상태 추가
        - 초기값은 배열로 구성
      - loadOnlineFriends 액션 추가
        - fetch 함수를 추가해 백엔드의 온라인 친구 목록을 조회하는 GET 라우터와 연결될 수 있도록 구성
        - 백엔드에서 넘어온 로그인 상태의 친구 정보를 set을 통해 onlineFriends 상태에 저장되어 업데이트되도록 구성
    - Friends
      - OnlineFriend 컴포넌트를 추가
      - useFriendStore Zustand에서 onlineFriends 상태와 loadOnlineFriends 액션을 불러와 사용할 수 있도록 구성
      - filteredOnlineFriends 변수 추가
        - filteredFriends 변수와 동일한 구성으로, 친구 목록에 map을 사용해 현재 로그인한 사용자 정보는 제외하고 친구 정보만 남겨서 그 내용을 하위 컴포넌트로 전달하도록 구성
      - 온라인 버튼 추가
        - 모두 버튼과 다르게 온라인 버튼 클릭 시에, 현재 로그인한 친구 목록만 뜨도록 구성
        - 온라인 버튼 클릭 시에 loadOnlineFriends 액션이 실행되고 조건부로 안보이던 내용이 보여지도록 구성
      - 온라인 버튼이 클릭되면 실행되어 보여지는 내용
        - filteredOnlineFriends 변수를 통해 걸러진 내용에 map을 사용해 다시 새로운 배열로 만들고, OnlineFriend 컴포넌트에 id, nickname 정보를 props로 전달하도록 구성
    - OnlineFriend
      - Friend 컴포넌트에서 구성된 내용을 가져와 사용
      - 삭제 관련된 액션, 그룹 채팅방 초대 관련된 액션, 다이렉트 채팅방을 추가하는 액션 내용을 불러와 사용될 수 있도록 구성
      - deleteFriendHandler 함수를 통해 친구를 삭제할 수 있도록 구성하고, 친구 삭제 시에 그룹 채팅방 초대 목록에서 해당 친구와 관련된 그룹 채팅방 초대 내용이 삭제되도록 구성
      - directChatHandler 함수를 통해 해당 친구와의 다이렉트 채팅방으로 이동될 수 있도록 구성
  - 온라인 상태의 친구 목록만 따로 볼 수 있도록 백엔드와 프론트엔드 로직을 추가하고, 온라인 버튼 클릭 시에 해당 로직이 작동되어 온라인 상태의 친구 목록만 따로 보여지도록 구성한 내용이 문제없이 작동되어, 모두 버튼 클릭 시에 전체 친구 목록이 보여지고, 온라인 버튼 클릭 시에 현재 로그인 상태인 친구 목록이 보여지는 것을 확인할 수 있었다.
    - 온라인 버튼이 문제없이 작동하긴 하지만, 온라인 상태의 화면에서 새롭게 친구가 로그인하거나 로그아웃을 할 경우, 실시간 반영이 되지 않고 새로고침하거나 다른 버튼을 클릭하고 돌아와야 적용이 되기 때문에, 이 내용에 실시간 반영을 추가해 로그인하고 로그아웃한 친구가 있다면 즉시 반영되어 보여지도록 구성을 해봐야 함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/c75f5d17302914d61e90144463eb2c13a871e97e)

<br />

- 온라인 친구 실시간 반영 로직 추가 (미완성)
  - 온라인 상태의 화면에서 친구가 로그인을 하면 해당 내용이 실시간으로 반영되어 온라인 상태에 해당 친구가 보여지도록 구성
  - 백엔드
    - app
      - mongodb 패키지를 불러오고, ObjectId 변수를 추가해 new ObjectId로 변환할 수 있도록 구성
      - registerUser 이벤트 수정
        - 비동기로 수정
        - friends 컬렉션에서 친구 목록을 불러오도록 구성
        - 온라인 상태인 친구 목록만 불러오도록 구성
        - 친구 목록과 온라인 상태의 친구 목록이 정상적으로 불러와지는지 확인하는 콘솔 로그 추가
        - 친구 목록에 forEach를 사용
          - friendId 변수
            - requester.id와 userId를 비교하고, 일치하면 receiver.id 내용을 저장, 일치하지 않을 경우 requester.id 내용을 저장하도록 구성
          - friendSocketId 변수
            - 현재 로그인 상태인 사용자 목록에 friendId 변수를 사용해 찾은 친구 id 정보를 넣어서 친구 소켓 ID를 찾도록 구성
          - 조건문
            - 찾은 친구에게 onlineFriend 이벤트를 통해 온라인 상태인 친구 목록을 전달하도록 구성
        - 현재 여기서 구성한 온라인 상태 실시간 반영 로직은 잘못된 구성으로 수정이 필요
          - 원래 생각했던 구조
            - A 사용자가 로그인하면 친구인 B, C 사용자에게 A 사용자와 관련된 친구 관계 정보를 전달해 B, C 사용자 화면의 온라인 상태 내용에 실시간 반영되는 구조를 생각함
          - 현재 구성된 구조
            - A 사용자가 로그인하면 친구인 B, C 사용자 중에 누가 온라인 상태인지 A 사용자에게 관련 내용을 전달하고 있기 때문에 내용을 수정해야 함
          - 내용을 수정해서 A 사용자가 로그인하면 해당 사용자 친구들에게 A 사용자가 온라인 상태라는 것을 알려줘야 함
            - 로그인하면 친구 목록을 순회해서 그 친구가 온라인 상태인지 확인하고, 그 친구에게 로그인했다는 것을 알리도록 구성을 해야 함
    - friend-routes
      - 온라인 친구 목록을 조회하는 GET 라우터 수정
        - 로그인한 사용자 정보를 어떤식으로 가져오는지 확인하기 위한 콘솔 로그 추가
        - 사용자 \_id가 정상적으로 변환되어 보이는지 확인하는 콘솔 로그 추가
        - `return onlineUsers.get(friendId)` 대신에 `return onlineUsers.has(friendId)`가 사용되도록 수정
          - has
            - 존재 여부를 빠르게 체크할 때 사용
            - true 또는 false 같은 boolean을 반환
            - 존재 유무만 boolean으로 반환
            - filter와 함께 사용하면 조건이 true인 것만 남겨서 저장하고 반환
            - ex) 온라인인지 여부만 체크해서 필터링하고 내용 반환할 때 사용
          - get
            - 값이 필요할 때 사용
            - value 또는 undefined를 반환
            - Map에서 값을 꺼내오며 값이 있으면 반환, 없으면 undefined 반환
            - ex) 소켓 ID나 유저 정보까지 사용해야 할 때 필요 (소켓 emit)
        - 친구 목록 및 온라인 친구만 필터링하는 콘솔 로그를 추가해 테스트하고 주석 처리
  - 프론트엔드
    - friendStore
      - loadOnlineFriends 액션 수정
        - socket 관련 내용을 추가
        - socket.off를 추가해 이벤트 리스너 중복 실행을 방지
        - socket.on 내용 추가
          - onlineFriend 이벤트를 통해 온라인 상태의 친구 목록을 받도록 구성
          - 받은 온라인 상태의 친구 목록이 기존 온라인 상태의 친구 목록에 추가되도록 구성
  - 온라인 상태의 화면에서 친구가 로그인하면 그 친구와 관계된 친구 목록 정보가 전달되도록 구성을 하고 테스트한 결과, 내가 생각한 구조대로 로직을 구성하지 않은 채로 데이터를 넘겨서 오류가 발생하기 때문에, 추가 수정을 통해 로그인한 친구와 관계된 친구 목록 데이터가 넘어오도록 수정을 해 줘야 한다.
    - 구성에 문제가 없다고 생각했지만, 로직을 다시 살펴보니 엉망진창 잘못된 로직이었고, 그로 인해 에러가 발생해 온라인 상태로 변경된 친구를 실시간으로 반영하지 못하기 때문에, 내용을 수정해 친구가 로그인하면 해당 친구와 관련된 정보가 넘어와 기존의 로그인 상태인 사용자 화면에 반영되어 데이터가 추가되도록 구성을 해 봐야 함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/9ccdb13e9abdf07a8548d5dab0bcce494e2a7f40)

# 오늘 느낀 점

- 온라인 상태인 친구 목록을 따로 출력하는 것은 어렵지 않게 해결을 했는데, 친구가 로그인하면 그 내용이 실시간 반영되어 온라인 상태에 보이도록 하는 기능은 제대로 구현을 하지 못해서 내용을 수정하고 다시 테스트를 진행해 봐야 한다. 현재 생각한 구조는 A 사용자가 로그인 상태로 있고, B 또는 C 사용자가 로그인하면 A 사용자 화면의 온라인 상태 친구 목록에 B 또는 C 사용자 정보가 전달되어 해당 사용자 정보를 화면에 실시간으로 출력하는 것인데, 이렇게 구성을 하려면 로그인한 사용자 친구 목록에 사용자가 로그인했다고 관련 정보나 알림을 보내야 하고 해당 정보를 활용해 실시간 반영이 되도록 구성해 봐야 할 것 같다. 그리고 반대로 로그아웃을 했을 때 이 내용도 실시간 반영되어 온라인 상태에서 보이지 않도록 구성을 해봐야 하며, 추가로 다이렉트 채팅방 목록에서 사용자 닉네임과 아이콘이 보여지고 현재 로그인 상태인지 확인까지 할 수 있도록 내용을 구성해 볼 생각이다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 채팅 메시지 입력창과 관련된 내용을 수정해 크기 조절과 줄바꿈 내용이 적용되도록 구성 필요

- 출력되는 채팅 메시지 목록에 스크롤을 추가해 보기 편하도록 변경해야 하고, 메시지가 언제 추가되었는지 구분할 수 있도록 저장된 날짜 데이터를 불러와 표기해야 함

- 다이렉트 채팅방 목록이 정렬될 때 부드럽게 위로 올라가고 내려가는 CSS 적용 필요

- 친구 삭제 시에 다이렉트 채팅방 삭제 확인 로직 필요 (친구 삭제 시에 다이렉트 채팅방을 그대로 남겨놓고 삭제 확인창은 따로 추가하지 않을 예정)

- 친구 관련된 내용에서 코드 정리 필요 (코드를 깔끔하게 보이도록 수정 필요)

- 그룹 채팅방 초대하고 알림을 전송하는 기능에서, 로그인한 사용자가 아닌 친구에게 보내는 그런 구조로 작동되도록 수정이 필요 (비로그인 상태여도 상관이 없음 단순하게 친구한테 친구 요청하면 알림 메시지가 전달되어야 함)

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방 (진행중)

- 여러 Zustand에 구성된 실시간 반영 로직들이 재사용될 수 있도록 커스텀 훅에 옮겨서 구성하는 것을 고려해야 함

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
