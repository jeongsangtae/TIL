# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 다이렉트 채팅방 목록 정렬 실시간 반영 추가 (메시지 받은 사용자 화면) 및 중복 에러 수정
  - 다이렉트 채팅방 메시지를 전달 받은 사용자 화면에 다이렉트 채팅방 목록이 실시간 반영되어 정렬되도록 내용을 구성해 주었고, 해당 내용 구성 중에 중복 관련 문제가 발생해서 오류를 수정
  - 백엔드
    - chat-routes
      - 채팅 메시지 추가하는 POST 라우터 수정
        - 다이렉트 채팅방이 닫혀있는 경우 작동되는 소켓 이벤트 이름 변경
          - updatedDirectChat에서 invisibleDirectChat로 변경
        - 다이렉트 채팅방이 열려있는 경우 작동하는 소켓 이벤트 추가
          - updatedDirectChat 소켓 이벤트에 updatedDirectChat 내용을 전달하도록 구성
          - 다이렉트 채팅방이 보이는 경우 작동되며 업데이트한 다이렉트 채팅방 정보를 프론트엔드로 전달
  - 프론트엔드
    - directChatStore
      - getDirectChat 액션 수정
        - 정렬 관련 변수를 추가
          - 재사용할 수 있도록 구성
          - 이전에 정렬하던 로직과 동일
          - `new Date(b).getTime() - new Date(a).getTime()`
        - invisibleDirectChat 소켓 이벤트 관련 socket.off 추가
          - 커밋한 내용을 보고 주석 처리한 사실을 알게 됨
          - 이 내용을 주석 처리해서, 소켓 관련 이벤트에서 중복이 발생했고 그로 인해 중복 방지 로직을 추가했었던 것 같음
          - 주석을 풀고 이전 로직으로 테스트한 결과, 중복 관련 에러가 없는 것을 확인
          - 중복 관련 로직을 지우고 이전에 사용하던 로직으로 수정하면 더 간결한 로직으로 사용 가능
        - invisibleDirectChat 소켓 이벤트 관련 socket.on 추가
          - 가독성 위주, 축약형, 중간 스타일 구조로 3가지 내용을 테스트해봄
          - 현재는 축약형으로 구성중
          - some으로 다이렉트 채팅방 목록에 저장된 \_id와 백엔드에서 전달받은 다이렉트 채팅방 \_id 내용을 비교
            - 해당 내용을 비교해 일치할 경우, 기존 다이렉트 채팅방 목록을 정렬
            - 일치하지 않을 경우, 백엔드에서 전달한 채팅방을 추가해 목록을 정렬하도록 구성
          - 추가 테스트 결과, some 관련 중복 방지 로직이 필요없는 것을 알게 되어 삭제 예정
        - updatedDirectChat 소켓 이벤트 관련 socket.on 내용 수정
          - 다이렉트 채팅방 목록에 map을 사용하고, 다이렉트 채팅방 목록 \_id와 백엔드에서 넘어온 다이렉트 채팅방 정보 \_id를 비교
            - 비교해 일치하는 항목일 경우, 백엔드에서 넘어온 다이렉트 채팅방으로 교체
            - 일치하지 않을 경우, 기존 다이렉트 채팅방으로 유지
          - 바뀐 목록에 sort를 사용해 최신 메시지 순서로 정렬하도록 구성
          - 업데이트가 필요한 채팅창만 새 데이터로 교체하고 그 다음 정렬해 최신 데이터가 최상단으로 가도록 구성
          - 추가로 이전에 사용하던 로직은 주석 처리
    - types
      - Participants 타입 정의 수정
        - isVisible 항목을 추가하고, boolean으로 정의
      - DirectChatData 타입 정의 수정
        - lastMessageDate 항목을 추가하고, string으로 정의
  - 다이렉트 채팅방에서 메시지를 추가하면 상대방 화면에서 해당 다이렉트 채팅방이 최상단으로 정렬되도록 구성하고 테스트한 결과, 실시간으로 최신 메시지가 넘어온 채팅방이 최상단으로 이동해 보이는 것을 확인할 수 있었다.
    - TIL을 작성하기 위해 커밋한 내용을 살펴보니, invisibleDirectChat 소켓 이벤트에서 중복 관련 에러가 발생한 이유는 socket.off 내용을 주석 처리하고 테스트를 진행해서 에러가 발생했고, 해당 문제를 해결하기 위해 some을 추가해 중복 방지를 해결했지만, socket.off 내용이 있으면 굳이 some 관련 로직이 필요가 없으므로 다시 내용을 수정해 이전의 간결한 로직으로 변경해야 함
    - 다이렉트 채팅방에서 메시지를 추가하면, 상대방 화면에서만 다이렉트 채팅방 목록이 정상적으로 정렬이 되고 메시지를 보낸 사용자 화면에서는 정렬이 되지 않기 때문에, 메시지를 보낸 사용자 화면의 다이렉트 채팅방 목록이 정렬할 방법을 찾아야 함
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/a113fd74a1135e8c50f304e1c0b77f4dd5de0697)

<br />

- 다이렉트 채팅방 목록 정렬 실시간 반영 추가 (메시지 보낸 사용자 화면)
  - 다이렉트 채팅방 메시지를 추가하면, 상대방 화면의 다이렉트 채팅방 목록만 정렬되고 보낸 사용자 화면은 정렬이 되지 않기 때문에, 메시지를 보낸 사용자 화면의 다이렉트 채팅방 목록이 정렬되도록 내용 수정
  - 프론트엔드
    - ChatInput
      - useDirectChatStore Zustand에서 directChats 상태와 getDirectChat 액션을 불러오도록 구성
      - sendMessageHandler 함수 수정
        - 비동기 함수로 구성하고 타입도 비동기 함수 타입으로 수정
        - sendMessage 액션에 await를 추가
        - directChatChecked 변수 추가
          - 불러온 다이렉트 채팅방 목록에 find를 사용해, 다이렉트 채팅방 목록 \_id와 roomId를 비교해 일치하는 항목을 찾도록 구성
        - getDirectChat 액션을 조건부로 실행하도록 구성
          - directChatChecked 변수를 통해 찾은 데이터가 유효하면 getDirectChat 액션이 실행되도록 구성
          - getDirectChat 액션에 await를 사용
          - 그룹 채팅방에서 메시지가 추가되면 directChatChecked 변수는 undefined되어 조건부가 실행되지 않음
          - 다이렉트 채팅방에서 메시지가 추가되면 directChatChecked 변수에는 값이 저장되고, 해당 값은 유효하기 때문에 조건부가 실행되어 getDirectChat 액션이 실행되는 구조
  - 추가한 채팅 메시지가 다이렉트 채팅방에서 추가된 메시지인지 확인이 될 경우, 다이렉트 채팅방 목록을 다시 불러와 정렬시키도록 구성하고 테스트한 결과, 문제없이 작동되어 메시지를 보낸 사용자 화면에서도 다이렉트 채팅방 목록이 실시간으로 정렬되는 것을 확인할 수 있었다.
    - 다이렉트 채팅방 메시지 추가 시에 다이렉트 채팅방 목록이 정렬되는 문제는 모두 해결이 된 것 같은데, 뭔가 구성이 조금 뒤죽박죽된 것 같은 느낌을 받아서 로직 정리와 사용하지 않고 주석 처리된 내용들을 정리해 줘야 함
    - 채팅 메시지를 입력하는 입력창 크기 조절이 현재 자유자재로 이루어지기 때문에 수정해 크기가 변경되지 않도록 해야 하며, 줄바꿈으로 입력한 내용이 출력되는 것도 적용되지 않고 있고, 채팅방 내부에서 출력되는 메시지가 스크롤없이 계속 늘어나기 때문에 이와 관련해 조절이 필요하기에 수정이 필요
    - 출력되는 메시지가 언제 작성한 메시지인지 알 수 있도록 메시지 추가한 날짜 데이터를 불러와 보여지도록 구성 필요
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/bdda14e99067685681dc62bae1268ea8cee3bafd)

# 오늘 느낀 점

- 다이렉트 채팅방 목록 정렬 관련 내용이 메시지를 보낸 사용자 화면과 받는 사용자 화면에서 실시간 반영되도록 로직을 구성했는데, 문제없이 작동되는 것 같아서 다행이라는 생각이 들었다. 솔직히 구성하면서 어려움이 많아서 제대로 구성이 될 지 걱정이 많았는데, 결과적으로 잘 해결이 된 것 같고 이 내용을 끝으로 다이렉트 채팅 관련 내용 구성이 얼추 마무리된 것 같아서, 이제 채팅창 크기 관련 내용과 채팅 목록 스크롤 관련 내용 등 채팅방 세부 페이지에서 보여지는 내용이 좀 정리되어 보이도록 내용을 수정해 줘야 할 것 같다. 그리고 이 외에 현재 CSS가 하나도 추가되지 않아서 보기 많이 불편하기 때문에 조금씩 추가해 원하는 구조대로 내용이 보여지는지 확인이 필요하고 생각한 구조와 다르다면 로직이나 라우터 구성을 수정해 줄 생각이다. 추가로, 빠진 기능은 없는지 확인이 필요하고, 더 추가할 내용이 있는지 확인을 위해 전체적인 내용 정리도 해 줄 생각이다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 다이렉트 채팅방 관련 로직을 구성할 때 테스트했던 주석 처리한 로직을 정리해야 하고 다른 필요없는 코드가 없는지 확인 필요

- 채팅 메시지 입력창과 관련된 내용을 수정해 크기 조절과 줄바꿈 내용이 적용되도록 구성 필요

- 출력되는 채팅 메시지 목록에 스크롤을 추가해 보기 편하도록 변경해야 하고, 메시지가 언제 추가되었는지 구분할 수 있도록 저장된 날짜 데이터를 불러와 표기해야 함

- 다이렉트 채팅방 목록이 정렬될 때 부드럽게 위로 올라가고 내려가는 CSS 적용 필요

- 친구 삭제 시에 다이렉트 채팅방 삭제 확인 로직 필요 (친구 삭제 시에 다이렉트 채팅방을 그대로 남겨놓고 삭제 확인창은 따로 추가하지 않을 예정)

- 친구 관련된 내용에서 코드 정리 필요 (코드를 깔끔하게 보이도록 수정 필요)

- 그룹 채팅방 초대하고 알림을 전송하는 기능에서, 로그인한 사용자가 아닌 친구에게 보내는 그런 구조로 작동되도록 수정이 필요 (비로그인 상태여도 상관이 없음 단순하게 친구한테 친구 요청하면 알림 메시지가 전달되어야 함)

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방 (진행중)

- 여러 Zustand에 구성된 실시간 반영 로직들이 재사용될 수 있도록 커스텀 훅에 옮겨서 구성하는 것을 고려해야 함

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
