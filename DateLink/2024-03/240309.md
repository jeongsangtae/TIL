# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - 게시글 추가 시 로그인한 사용자 정보를 함께 저장 (이름, 이메일) & 로그인을 하지 않았을 때, 게시글 추가하지 못하게 제한
    - 게시글 추가 시 로그인한 사용자 정보의 이름과 이메일이 함께 추가되어 저장되도록 구성을 추가
    - 로그인을 하지 않은 경우 게시글을 추가하지 못하게 제한해주고, 로그인을 하고 게시글을 추가한다면 작성자에 로그인한 사용자의 이름이 자동으로 들어가 있도록 구성
    - 백엔드 구성
      - 게시글 추가 시 로그인한 사용자 정보 함께 저장하는 구성 내용
        - 환경변수에서 accessToken 키를 가져오고 accessToken 코드를 활용해서, 쿠키에 저장된 accessToken을 확인하고 verify를 통해서 인증
        - 사용자 토큰 데이터가 문제 없는지 확인하고, 문제가 없다면 사용자 토큰 데이터의 사용자 이메일과 DB에 저장된 사용자 이메일을 비교해서 일치하는 사용자를 찾는다.
        - 찾은 사용자 내용에서 패스워드를 제외한 이름과 이메일 정보를 추출하고 게시글이 추가될 때 해당 내용을 함께 포함하여 저장하도록 구성
      - 로그인 하지 않은 경우 제한하는 내용 관련 구성 내용
        - 예외처리를 위해 try-catch문을 추가하고, 그 안에 accessToken을 확인하는 코드를 구성
        - token이 없다면 로그인하지 않은 사용자라는 메시지를 error로 전달
        - 로그인을 했는데, DB에 저장된 사용자 정보에서 일치하는 내용이 없다면 존재하지 않는 사용자라는 메시지를 error로 전달
          - 사실상 이 코드는 말이 안된다고 생각되어 빼는 쪽으로 생각 중
          - 로그인 시 조건부를 추가해놓은 상태이기 때문에 이 error 메시지가 전달될 수 없음
        - 로그인한 사용자라면 token이 존재하기 때문에, DB에서 일치하는 사용자를 찾아서 비밀번호를 제외한 데이터를 프론트엔드로 전달하도록 구성
        - 로그인하지 않은 사용자라면 token이 존재하지 않고, DB에서 데이터도 찾을 수 없기 때문에 기존의 게시글, 페이지네이션 관련 정보만 전달해서 보여지도록 구성
    - 프론트엔드 구성
      - 게시글 추가 시 로그인한 사용자 정보 함께 저장하는 구성 내용
        - 프론트엔드에서 별 다른 코드를 추가하지 않고, 백엔드에서 구성한 jwt 토큰 인증 관련 코드의 오류가 발생하지 않도록 `credentials: "include"` 이 코드를 fetch 함수의 내용에 추가해주었다.
      - 로그인 하지 않은 경우 제한하는 내용 관련 구성 내용
        - PostsPage 라우터에서 사용하는 loader 함수를 재사용하기 위해서, CreatePostPage 라우터에도 loader 함수를 추가해서 사용할 수 있도록 구성 추가
          - loader 함수 재사용에 대해 찾아봤는데 재사용해도 문제가 없다는 것을 알게 되어 재사용
        - CreatePostPage 라우터 컴포넌트에서 useLoaderData Hook를 추가하고, loader 함수를 통해 응답 데이터 내용을 전달 받아서 PostForm 컴포넌트에 prop으로 해당 데이터를 전달
        - PostForm 컴포넌트의 작성자 부분에서 postData가 존재 하지 않는 경우, 전달받은 prop을 사용해서 작성자 부분에 로그인한 사용자의 이름이 미리 들어가 있도록 구성
    - 현재 게시글 추가에서 로그인한 사용자는 문제 없이 게시글을 생성할 수 있고, 로그인하지 않은 사용자는 게시글 추가를 못하게 구성해놓았는데, 게시글 추가 버튼은 클릭이 되기 때문에 이 부분 수정이 좀 필요한 상황이다.
      - 로그인하지 않은 경우 게시글 추가 버튼이 안보이게 하거나, 게시글 추가 버튼에 opacity 관련 내용을 추가해서 클릭하지 못하게 구성하는 방향으로 생각 중이다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/323874ba8cb97213064da1fee582e22d89f6df87)

<br />

- 추가 및 해결 해야 할 내용
  - 회원가입 form에서 잘못된 입력을 제출 했을 때, session에 데이터가 저장되는데, 기존의 session 데이터에서 업데이트되는 방식이 아닌 매번 제출할 때마다 새로운 session이 추가되고 있기 때문에 백엔드 코드에서 수정이 필요하다.
    - 계속 원인을 찾아보려고 이것저것 시도해보았지만 아직 어떤 코드가 정확히 원인인지 찾지 못해서 하나씩 천천히 테스트가 필요함
    - 일단 이걸 테스트 해보기전에 먼저 정상적으로 세션 만료가 되는지 확인해보았는데 정상적으로 세션 만료가 되기 때문에, 로그인을 먼저 구성해보고 정상적으로 로그인이 되는지 확인을 해보고 안된다면, session에 저장되는 부분을 다시 확인해봐야 할 것 같다는 생각
  - 로그인 후에, 새로고침 시 로그아웃 되어버리는 상황도 수정을 해야 함
    - 현재 로그인 한 후에, useEffect를 통해서 데이터를 확인하고 토큰이 유효하다면 정상적으로 로그인 유지는 되지만, 새로고침 시 깜빡거리면서 메인헤더가 변경되는 것이 보이기 때문에 이 부분을 수정할 수 있으면 수정할 생각이다.
  - 로그인을 유지하고 있을 때, token이 만료 시간에 가까워지면 자동으로 갱신되는 로직을 추가 해야 함
    - 대충 구성만 되어 있는 상태로, 좀 더 자세한 코드와 테스트가 필요함
  - 로그인 시 주어지는 토큰을 확인하고, 해당 토큰을 통해 인증하고 게시글, 댓글, 답글 관련 기능을 활성화해주는 코드를 구성해야 함
    - 전체적으로 저 인증을 확인할 수 있게 해주는 것이 1차 목표로, 애플리케이션 전체에서 인증을 확인할 수 있게 된다면 쉽게 구성이 될 것으로 예상된다.
    - 세션과 연동이 가능한 부분이 있는지도 테스트가 필요함
      - 불가능 세션이나 jwt 토큰 중 하나만 사용하는 것이 좋다.
    - 일단 너무 어렵게 생각하는 것보다는 로그인 유무로 메인 헤더가 변경되기 때문에 이 내용을 가지고 테스트해보면서 하나씩 확인하면서 구성하면 될 것으로 예상됨

# 오늘 느낀 점

- 게시글 추가 시 로그인한 사용자의 정보가 함께 저장되도록 백엔드에서 코드를 구성하고 테스트를 진행했는데, `return done(new JsonWebTokenError('jwt must be provided'));` 이러한 오류가 발생해서 찾아보니, JWT 토큰이 요청에 포함되지 않아서 발생하는 오류라고 한다. 분명히 JWT 토큰을 확인하는 코드를 추가했는데 왜 오류가 발생하는지 생각해본 결과, 게시글을 추가하는 post method가 구성된 fetch 함수의 내용에서 `credentials: "include"` 이 내용을 추가해주지 않은 것 같아서 추가해주니 문제없이 작동되는 것을 확인할 수 있었다.

- 현재 PostsPage에 있는 loader 함수를 재사용해서 CreatePostPage에서도 적용시키고 useLoaderData를 사용해서 데이터를 전달받고, 전달 받은 데이터를 PostForm 컴포넌트에 prop을 통해서 데이터를 전달하고 있다. 이 방법 대신에 useRouteLoaderData를 사용하는 것도 생각했지만, 이건 게시글을 새롭게 추가하는 내용에서는 올바른 방법이 아니라고 생각되어 사용하지 않았다. useRouteLoaderData를 사용해도 데이터를 못 가져올 것 같다는 생각이 들었고, 직접 확인해보기 위해서 테스트를 진행했는데 생각한대로 undefined가 콘솔에서 확인되며, 어떤 데이터도 가져오지 못하는 것을 확인할 수 있었다.

- 이제 로그인한 사용자만 게시글을 추가할 수 있고, 게시글 추가 시 작성자에 로그인한 사용자의 이름이 들어와 있도록 구성이 되었다. 로그인을 한 경우라면 문제없이 게시글을 추가할 수 있지만, 로그인을 하지 않은 경우 게시글 추가 버튼을 클릭하면 에러가 발생하기 때문에 이 에러에 대한 예외처리를 해줘야 한다. 로그인을 하지 않은 경우 게시글 버튼을 보이지 않도록 해주거나, 비활성화 해주는 방향으로 생각중인데, 로그인하지 않은 사용자가 버튼을 클릭해서 오류가 발생하는 일은 없도록 구성을 해줘야 할 것 같다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
