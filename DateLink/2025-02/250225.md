# 오늘 한 일

### React + TypeScript 프로젝트 제작 (React, TypeScript, ExpressJS, MongoDB로 만드는 실시간 통신 애플리케이션)

- 그룹 채팅 나가기 로직 추가, 주석 처리 및 그룹 채팅 참여 이벤트에서 방 나가기 이벤트 삭제
  - 그룹 채팅방을 나가는 액션과 소켓 이벤트 로직을 추가했는데, 막상 추가하고 사용하려고 보니 사용하기에 애매해서 주석 처리해 놓은 상태
  - 백엔드
    - app
      - 방 나가기와 관련된 socket 이벤트 내용 추가
        - leaveRoom 이벤트는 roomId를 전달받고, chatRoomId에 방 번호를 저장
        - socket.leave를 사용해 해당 방에서 나가도록 구성
        - 방 나갔을 때 콘솔에 메시지 출력
        - 현재는 사용하지 않는 로직이기 때문에 주석 처리
  - 프론트엔드
    - socketStore
      - joinGroupChat
        - 방 나가기와 관련된 socket.emit 내용 삭제
      - leaveGroupChat
        - socket을 불러오는 내용 추가
        - 불러온 소켓과 현재 방 번호를 확인하고 없을 경우, return으로 종료
        - socket.emit을 사용해 leaveRoom 이벤트에 불러온 현재 방 번호를 전달
        - set을 통해 currentRoom을 null로 업데이트
        - 콘솔에 채팅방 나갔다는 메시지를 출력
        - 현재 이 로직은 사용하지 않고 주석 처리
  - 방 나가기 로직은 테스트를 진행하기 애매해서, 테스트를 진행하지 않고 일단 추가하고 주석 처리해 놓았다.
    - 구성하려는 구조는 디스코드처럼 여러 방을 구독하는 시스템으로 진행할 계획이라서, 방 참여는 사실상 현재 채팅을 입력할 수 있는 방 개념이고, 방 나가기는 방장이 아닌 다른 사용자가 해당 채팅방을 나갈 때 사용하거나, 아니면 삭제할 예정이다.
    - 방장이 아닌 다른 사용자가 방 삭제 기능으로 동일하게 방 나가기를 할 수도 있기 때문에 이 내용은 좀 더 구성을 해 봐야 확실하게 정해질 것 같은데, 현재 방에 초대하는 기능이 없어서 다른 사용자가 다른 방에 참여할 수 없고, 방 나가기도 테스트할 수 없기 때문에 우선, 방 초대하는 기능이 추가되어야 할 것 같음
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/66793fafc2fe13a10bf999d3e0bae800685d5c32)

<br />

- 새로운 메시지 알림 로직 추가 (미완성)
  - 새로운 메시지가 추가되면 친구 요청 알림처럼 새로운 메시지 추가 알림 메시지가 보여지도록 connect 액션 내부에 소켓 이벤트 내용을 구성하고, 백엔드에서도 마찬가지로 소켓 관련 내용을 추가해 연결하긴 했으나, 부족한 내용이 많아서 내용을 추가하고 수정 필요
  - 백엔드
    - app
      - roomId와 socketId를 저장할 roomUsers 추가
        - onlineUsers처럼 new Map으로 구성
        - 채팅방에 참여한 사용자의 소켓 ID를 관리하는 객체
        - key는 채팅방의 roomId, value는 해당 방에 참여한 소켓 ID들의 배열
      - set을 추가해 roomUsers 사용할 수 있도록 구성
      - joinRoom 이벤트가 실행될 때, 방에 사용자를 추가하기 위한 로직 추가
        - chatRoomId로 채팅방에 소켓을 추가하며, socket.id는 해당 방에 참여한 소켓으로 등록
        - `if (!roomUsers.has(chatRoomId)) { roomUsers.set(chatRoomId, [])`
          - 해당 방에 소켓 ID 배열이 없다면 새로 생성하여 배열을 초기화하도록 구성
        - `roomUsers.get(chatRoomId).push(socket.id)`
          - 방에 참여한 소켓의 ID를 해당 방의 배열에 추가
    - group-chat-routes
      - 채팅 메시지를 저장하는 라우터에 알림 관련 로직 추가
        - roomId 정보로 일치하는 그룹 채팅방을 찾도록 구성
        - `const roomUsers = req.app.get("roomUsers")`
          - req.app.get을 사용해 Express의 app 객체에 저장된 roomUsers를 가져옴
        - `const roomSockets = roomUsers.get(chatRoomId)`
          - chatRoomId에 해당하는 방의 소켓 ID 배열을 가져옴
          - ex) room-12 방에 2명이 입장했다면 roomSockets는 `["socketId1", "socketId2"]` 이런식으로 가져옴
        - `roomSockets.forEach((socketId) => {...}`
          - 방에 입장한 모든 소켓 ID에 대해 반복문을 돌려, 각각의 소켓에 messageNotification 이벤트를 보냄
          - forEach는 배열의 각 요소에 대해 반복하며 실행하고, roomSockets 배열의 각 요소(socketId)에 대해 알림을 보냄
          - roomSockets 배열에 있는 각 소켓 ID에 대해 `io.to(socketId).emit()`을 사용해서 해당 소켓에 알림 메시지를 보냄
          - 해당 알림 정보에는 id, roomTitle, message를 포함
  - 프론트엔드
    - socketStore
      - connect 액션 수정
        - 액션 내부에 messageNotification 이벤트 내용을 추가
        - 기본적으로 friendRequest 이벤트 내용과 거의 유사
        - 차이점은 이벤트 이름과 변수명
        - 현재 열려 있는 채팅방에서 온 메시지는 알림을 추가하지 않는 조건문을 추가하려고 했으나, 아직 기본적인 알림도 제대로 구성되지 않아서 주석 처리
    - DirectChats
      - 알림 내용을 출력하는 조건부 내용 수정
        - && 내용에서 ?로 수정해 "friendRequest" 내용인지 확인하고 일치할 경우 친구 요청 알림 메시지를 출력하고 아닐 경우, 새로운 메시지 추가 알림 메시지를 출력
        - 새로운 메시지를 출력할 때는 roomTitle 내용을 포함해 출력
    - Chats
      - newMessage, connect 액션 삭제
      - useEffect에서 주석 처리한 setTimeout 내용 삭제 및 주석 처리한 useEffect 삭제
  - 새로운 메시지가 추가될 때 알림이 전송되도록 구성하고 테스트한 결과, 알림이 전송되긴 하지만 사용자가 방에 한 번 참여를 한 뒤에, 그 방 정보가 있는 상태에서만 메시지 알림이 전송되고 있기 때문에 추가 수정이 필요함
    - 테스트 단계에서 생각한 구조는 우선, 사용자가 참여하고 있는 모든 방에서 새로운 메시지가 추가되면 알림이 전송되어 바로 보여지는 것을 생각했으나, 현재 구성은 마지막으로 참여한 방의 알림만 전송되기 때문에 수정이 필요
    - 사용자가 현재 참여 중인 방을 추적하는 내용이 필요하고, userRooms 맵을 추가해 사용자별로 참여 중인 방 관리도 필요할 것 같음
    - 추가로, 현재 방에 초대하는 기능이 없어서 다른 사용자로 테스트를 못하기 때문에 방에 초대하는 기능이 우선 추가되어야 할 것 같음
  - [코드 내용](https://github.com/jeongsangtae/float-chat/commit/9222e758c596d9f014bad3ebf861d6e12885b60a)

# 오늘 느낀 점

- 방 나가기 기능은 현재 굳이 필요없다고 생각되어, 내용만 추가해 놓고 주석처리를 해 놓았고, 새로운 메시지가 추가되었을 때 알림이 뜨도록 하는 기능은 구성을 하긴 했지만, 생각한 동작과는 조금 다르게 작동되므로 부족한 내용을 추가하고 좀 더 내용을 수정해 줘야 한다. 사용자가 참여한 방을 추적하는 내용과 새로운 맵 내용을 추가해 사용자별로 참여 중인 방 관리에 대한 내용도 추가해야 하는데, 이 내용들을 추가하기 전에 우선, 방에 초대하는 기능이 없어서 다른 사용자 계정으로 알림이 넘어오는지 확인이 불가능하기 때문에 사용자를 방에 초대하는 기능부터 추가를 해 줘야 할 것 같다. 채팅방 초대와 관련된 내용은 원래 초대 코드를 보내는 방식을 생각했으나, 현재 방에 초대하는 기능이 급하기 때문에 일단은 친구 요청처럼 방에 초대하는 요청을 보내고, 수락하면 그룹 채팅방 목록에 추가되는 형식으로 구성을 해 줘야 할 것 같다.

<br />

# 내일 할 일

- 실시간 통신 애플리케이션 (Float Chat) 프로젝트 진행

- Zustand 내용 구성

- 그룹 채팅방 초대하는 기능

- 새로운 메시지 추가되었을 때 알림 뜨는 기능 (추가하긴 했으나, 미완성)

- 친구 관련된 내용을 좀 다듬어야 함 (코드를 깔끔하게 보이도록 수정 필요)

- 친구 관련된 내용에서 타입 정의 및 코드 정리 필요

- 소켓 관련 내용에서도 타입 정의 필요

- 그룹 채팅방에서 채팅 메시지가 추가되면 전역적으로 알 수 있도록 알림이 떠야 하고, 그 알림 관리를 소켓 Zustand에서 할 수 있도록 구성 필요

- 추가된 친구와 대화를 나눌 수 있는 다이렉트 채팅방

<br />

# 앞으로 해야 할 일

- React, TypeScript 공부

- React 상태 관리 도구인 Zustand 공부

- 실시간 통신 애플리케이션 프로젝트 제작
