# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - JWT 토큰을 sessionStorage에 저장
    - bodyParser.json() 대신에 express.json()으로 변경
      - express 4.16.0 버전부터 express.json을 사용하도록 변경되었다.
      - 이 내용이 JWT와 크게 관련이 있는 것은 아니지만 그래도 변경해줌
    - JWT 토큰이 계속 sessionStorage에 저장이 되지 않아서, 테스트해보기 위해서 코드의 순서도 변경하고 `router.use("/login", jwtAuth);` 이 부분을 주석처리하고 테스트 해본 결과 정상적으로 token이 생성되는 것을 확인할 수 있었다.
      - 이제서야 다시 생각해보면 코드 순서를 딱히 변경할 필요없이 저 router.use 부분을 주석 처리하고 먼저 테스트 했다면 쉽게 알 수 있지 않았을까 하는 생각이 듬
    - 로그인을 진행하면 정상적으로 sessionStorage에 토큰이 저장되며 로그인이 되는 것을 확인할 수 있었다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/4f3d45fd1f43b162595e55df47f74e9820525fb8)

  <br />

  - dotenv 테스트 및 토큰 분리 (access token, refresh token)
    - env 파일에 저장한 비밀 키를 환경 변수로 사용하기 위해서 dotenv 라이브러리 내용을 session.js, jwt-auth.js 그리고 user-router.js에서 사용하고 있는데, 중복으로 라이브러리를 호출해서 사용하고 있기 때문에 app.js에서 전역적으로 사용하도록 변경
      - jwt-auth.js, user-router.js는 전역적으로 사용하는 dotenv가 정상적으로 적용되지만 session.js는 적용되지 않아서 session.js는 dotenv를 직접 추가해서 사용하는 것으로 유지
    - token도 access token과 refresh token으로 분리하기 위해 작업을 진행해주었는데, 기존에 사용하던 token은 access token으로 사용하고 refresh token은 추가해주었다.
      - access token은 만료 시간을 1m으로 지정, refresh token은 만료 시간을 1h로 지정
    - token을 분리는 해주었지만, 아직 제대로 테스트는 진행하지 않았는데 코드를 더 추가한 후에 테스트를 진행할 생각이다.
    - 추가로 JWT 관련 내용 정리가 필요해보여서 JWT 내용을 정리하고 갈 생각이다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/12db0b3c9fadc1748641245309f967b49d3a6884)

<br />

- 추가 및 해결 해야 할 내용
  - 회원가입 form에서 잘못된 입력을 제출 했을 때, session에 데이터가 저장되는데, 기존의 session 데이터에서 업데이트되는 방식이 아닌 매번 제출할 때마다 새로운 session이 추가되고 있기 때문에 백엔드 코드에서 수정이 필요하다.
    - 계속 원인을 찾아보려고 이것저것 시도해보았지만 아직 어떤 코드가 정확히 원인인지 찾지 못해서 하나씩 천천히 테스트가 필요함
    - 일단 이걸 테스트 해보기전에 먼저 정상적으로 세션 만료가 되는지 확인해보았는데 정상적으로 세션 만료가 되기 때문에, 로그인을 먼저 구성해보고 정상적으로 로그인이 되는지 확인을 해보고 안된다면, session에 저장되는 부분을 다시 확인해봐야 할 것 같다는 생각
  - 로그인이 되는지 확인하고, 로그인이 되었다면 메인헤더가 변경되도록 구성해야 함
    - `req.session.isAuthenticated`를 프론트엔드에 전달해서, useState를 이용해 메인헤더가 변경되도록 해주면 될 것 같음 (완료)
    - 현재 결과로 따지면 로그인도 되고, 메인헤더가 변경되긴 하지만 순환 참조 오류가 있어서 추가 작업이 필요함 (완료)
    - 로그인 시 `isAuthenticated` 정보가 MainHeader 컴포넌트로 넘어가서 useState에 true로 값이 저장되며, 해당 값을 사용해서 조건부 렌더링이 작동하도록 구성해서 순환 참조 오류없이 작동하도록 구성 (완료)
  - 로그인 후에, 새로고침 시 로그아웃 되어버리는 상황도 수정을 해야 함
    - JWT를 사용해서 클라이언트 측에서 state를 유지하게 해줘야 한다.
      - 사용자의 인증 정보를 클라이언트에 저장해서 지속적으로 유지해야 함
    - session에서 넘어온 데이터를 통해 sessionStorage에 저장해서 로그인이 유지되도록 구성되어 있으며, 이 내용에 JWT를 추가해서 구성해볼까 생각중
      - 로그인은 새로고침 시에도 문제없이 유지됨
  - 로그아웃 기능도 추가해야 함
    - 로그인이 성공하면 메인헤더가 변경되고 로그아웃 버튼이 추가되며, 로그아웃 버튼 클릭 시 메인 헤더의 내용이 초기 상태로 돌아오도록 구성을 해줘야 함 (완료)
    - 구성한 내용을 테스트 해본 결과 정상적으로 동작하고 있기 때문에 이 상태로 유지하고 추가로 로그인 관련 코드를 변경하면 추가 수정을 해줄 생각이다.
  - JWT 관련 코드 문제
    - 이전 오류를 테스트하기 위해 router.use를 사용하는 부분을 주석 처리하고 진행한 결과 정상적으로 토큰이 생성되고 추가되는 것을 확인했다.
    - sessionStorage에 토큰이 추가된 채로 다시 router.use 코드의 주석을 풀고 테스트해본 결과 토큰이 있음에도 여전히 토큰이 없다는 메시지가 뜨고 있기 때문에 이 부분의 수정이 추가로 필요하다.
    - JWT에 대해 좀 더 알고 사용해야 할 것 같아서, 찾아본 내용에 대해 정리를 하고 코드를 구성할 생각이다.
      - 그리고 sessionStorage에 저장하는 것도 좀 고려를 해봐야 할 것 같고, http 응답 헤더 방식을 사용하는 것도 좀 변경이 필요해보인다.

# 오늘 느낀 점

- JWT 토큰을 sessionStorage에 저장할 수 있게 되었는데, 문제는 jwt-auth 파일을 구성한 내용 때문인건지 router.use의 문제인지는 아직 정확히 알 수는 없지만 아마 내 생각엔 router.use를 사용할 때 에러가 발생한게 아닌, jwt-auth의 토큰 관련 내용에서 에러 처리 메시지가 작동한 것으로 볼때 jwt-auth 파일의 코드 내용이 좀 문제가 된 것 같다는 생각이 든다. 그래서 일단은 jwt-auth의 내용을 사용하지 않고 코드를 구성한 후에 조금씩 테스트를 진행하면서 어떤 부분이 문제인지 찾아야 할 것 같다. 그리고 session을 사용하지 않는 방향도 생각중이며, token도 access token과 refresh token으로 분리할 생각이고, sessionStorage에 저장하는 http 응답 헤더 방식이 아닌 cookie에 저장하는 방식으로 변경할 생각을 하고 있다. 이 내용은 가볍게라도 정리를 하고 진행할 생각이다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
