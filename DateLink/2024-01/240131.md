# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - access token verify 추가 (기존의 jwt-auth.js 수정) 및 프론트엔드에서 access token get router 추가
    - body-parser 라이브러리는 더 이상 사용하지 않기 때문에 삭제
    - jwt.verify를 다시 구성하기 위해서 jwt-auth.js 내용을 수정
      - access token과 refresh token을 분리해서 구성하기 위해서 기존의 jwtAuth에서 accessToken으로 변경하고 accessToken을 먼저 구성
      - accessToken의 비밀 키가 필요하기 때문에 환경 변수를 사용해서 키를 가져옴
      - `req.cookies.accessToken`을 사용해서, 클라이언트로부터 수신된 HTTP 요청의 쿠키 중에서 이름이 accessToken인 쿠키의 값을 가져온다.
        - 클라이언트가 HTTP 요청을 보낼 때, 브라우저는 해당 도메인에 설정된 쿠키 중에서 이름이 accessToken인 쿠키를 포함하여 서버로 전송한다.
      - jwt.verify 내용에 앞에서 accessToken이라는 이름의 쿠키 값과 accessTokenKey를 가져와서 구성
      - jwt.verify를 통해 검증한 사용자 email 정보를 사용하여 mongodb의 users 컬렉션에서 해당 사용자를 찾는다.
      - 찾은 사용자 정보를 JSON 형식으로 클라이언트에게 응답을 보내도록 구성
        - 이렇게 구성하면 클라이언트가 요청을 보낼 때, 토큰을 함께 전송하여 인증된 사용자임을 확인할 수 있다.
        - 클라이언트가 요청을 보낸 사용자의 정보를 인증하고, 해당 사용자의 데이터를 요청한 클라이언트에게 반환하기 위해서 해당 내용을 구성한 것이다.
      - 서버는 토큰을 검증하여 해당 사용자의 이메일 정보를 가져오고, 이 정보를 사용하여 사용자의 프로필이나 기타 관련 정보를 반환할 수도 있다.
    - jwt-auth.js에서 구성한 access token verify를 테스트하기 위해서 MainHeader.jsx에서 get router와 관련된 fetch 함수 추가
      - 테스트 하기 위한 액세스토큰 버튼을 추가하고, accessTokenTestHandler 함수에 fetch 함수를 추가해서, `"http://localhost:3000/accessToken"` 경로로 지정하고 `credentials` 또한 true로 설정해주었다.
      - 이렇게 구성해주면서 백엔드에서 구성한 access token verify의 테스트를 진행해볼 수 있게 되었다.
    - 이제 verify를 통해서 검증한 토큰의 정보에서 mongodb에 저장된 user 컬렉션에서 사용자 email이 일치하는 정보를 찾아놓고, 클라이언트 측에서 요청을 보내면 그 때 사용자의 정보를 반환하게 된다.
      - 이 내용에 비밀번호도 포함되어 있기 때문에 비밀번호는 보내지 않도록 구성을 추가해야 한다.
      - 물론 비밀번호는 해싱되어 있지만, 그래도 만약을 위해서 비밀번호는 함께 반환되지 않도록 추가 구성이 필요하다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/e8fc0d91ed9b624d7236c24efc4295c6d900e4ae)

<br />

- 추가 및 해결 해야 할 내용
  - 회원가입 form에서 잘못된 입력을 제출 했을 때, session에 데이터가 저장되는데, 기존의 session 데이터에서 업데이트되는 방식이 아닌 매번 제출할 때마다 새로운 session이 추가되고 있기 때문에 백엔드 코드에서 수정이 필요하다.
    - 계속 원인을 찾아보려고 이것저것 시도해보았지만 아직 어떤 코드가 정확히 원인인지 찾지 못해서 하나씩 천천히 테스트가 필요함
    - 일단 이걸 테스트 해보기전에 먼저 정상적으로 세션 만료가 되는지 확인해보았는데 정상적으로 세션 만료가 되기 때문에, 로그인을 먼저 구성해보고 정상적으로 로그인이 되는지 확인을 해보고 안된다면, session에 저장되는 부분을 다시 확인해봐야 할 것 같다는 생각
  - 로그인이 되는지 확인하고, 로그인이 되었다면 메인헤더가 변경되도록 구성해야 함
    - `req.session.isAuthenticated`를 프론트엔드에 전달해서, useState를 이용해 메인헤더가 변경되도록 해주면 될 것 같음 (완료)
    - 현재 결과로 따지면 로그인도 되고, 메인헤더가 변경되긴 하지만 순환 참조 오류가 있어서 추가 작업이 필요함 (완료)
    - 로그인 시 `isAuthenticated` 정보가 MainHeader 컴포넌트로 넘어가서 useState에 true로 값이 저장되며, 해당 값을 사용해서 조건부 렌더링이 작동하도록 구성해서 순환 참조 오류없이 작동하도록 구성 (완료)
  - 로그인 후에, 새로고침 시 로그아웃 되어버리는 상황도 수정을 해야 함
    - JWT를 사용해서 클라이언트 측에서 state를 유지하게 해줘야 한다.
      - 사용자의 인증 정보를 클라이언트에 저장해서 지속적으로 유지해야 함
    - session에서 넘어온 데이터를 통해 sessionStorage에 저장해서 로그인이 유지되도록 구성되어 있으며, 이 내용에 JWT를 추가해서 구성해볼까 생각중
      - 로그인은 새로고침 시에도 문제없이 유지됨
  - 로그아웃 기능도 추가해야 함
    - 로그인이 성공하면 메인헤더가 변경되고 로그아웃 버튼이 추가되며, 로그아웃 버튼 클릭 시 메인 헤더의 내용이 초기 상태로 돌아오도록 구성을 해줘야 함 (완료)
    - 구성한 내용을 테스트 해본 결과 정상적으로 동작하고 있기 때문에 이 상태로 유지하고 추가로 로그인 관련 코드를 변경하면 추가 수정을 해줄 생각이다.
  - JWT 관련 코드 문제
    - 이전 오류를 테스트하기 위해 router.use를 사용하는 부분을 주석 처리하고 진행한 결과 정상적으로 토큰이 생성되고 추가되는 것을 확인했다.
    - sessionStorage에 토큰이 추가된 채로 다시 router.use 코드의 주석을 풀고 테스트해본 결과 토큰이 있음에도 여전히 토큰이 없다는 메시지가 뜨고 있기 때문에 이 부분의 수정이 추가로 필요하다.
      - 이제 쿠키에 token을 저장하기 때문에 router.use 코드를 다시 테스트해봐야 하지만, 아직 코드 구성이 끝나지 않았기 때문에 추가 구성을 한 후에 테스트할 예정이다.

# 오늘 느낀 점

- refresh token까지 verify를 추가하고 싶었지만, access token의 verify를 추가하고 테스트하는데 시간을 다 소비해버렸다. 기존의 jwt-auth.js를 통해서 verify를 테스트할 때는 제대로 진행이 되지 않았는데 이번에 여러 정보를 참고 한 후에 하나씩 천천히 테스트를 진행해보니 결과적으로 verify 부분을 테스트해볼 수 있었다. 하나씩 천천히 테스트를 진행해보면서 어떤 부분이 부족했는지 알 수 있었고, 어떤 내용을 추가해야 하는지 조금씩 감이 잡히는 것 같다. 아직 완벽하다고는 할 수 없지만 그래도 어느정도 틀은 잡힌 것 같아서, access token verify의 내용에서 비밀번호가 포함되어 있기 때문에 비밀번호는 포함되지 않도록 수정이 필요해보이고, refresh token의 verify도 추가가 필요할 것 같다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
