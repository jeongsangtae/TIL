# 오늘 한 일

### React 프로젝트 제작 (React, NodeJS, MongoDB로 만드는 미니 커뮤니티 플랫폼)

- 구성한 내용

  - jsonwebtoken 라이브러리 추가 및 JWT 인증과 관련된 파일 추가
    - JWT를 사용하기 위해서 라이브러리를 백엔드에서 설치
    - jwt-auth.js라는 파일을 생성해서 미들웨어에 추가
    - jwt-auth.js 파일 구성
      - 우선 token에서 header를 "Authorization"로 설정
      - token key가 필요하기 때문에 env에 token key도 설정해서 환경변수를 불러온다.
        - env 파일에서 내용을 불러오기 때문에 dotenv.config를 통해서 환경변수를 불러오는데 오류가 생기지 않게 해준다.
      - token이 존재하지 않는지 확인하고 존재하지 않는다면, 오류 메시지를 전달
      - jwt를 확인하는데, 여기서 token과 tokenKey를 확인 그리고 확인이 완료된 후에 실행될 콜백 함수를 포함
        - jwt.verify는 세 개의 매개변수를 사용하는 함수로, 확인할 토큰(token), 비밀 키(tokenKey), 확인이 완료된 후에 실행될 콜백 함수를 포함한다.
        - 콜백 함수는 두 개의 매개변수 err와 user를 포함
          - 토큰 확인 중에 오류가 발생하면 err 매개변수가 채워지고, 함수는 403 status 코드와 함께 토큰 확인 실패 메시지를 포함한 JSON을 응답하도록 구성
          - 토큰 확인이 성공하면 콜백 함수의 user 매개변수는 JWT의 페이로드를 나타낸다.
            - 일반적으로 페이로드에는 사용자에 관한 정보가 포함되어 있다.
            - `req.user = user`를 사용하여 확인된 사용자 정보를 req 객체에 추가, 이후에 미들웨어나 라우트 핸들러에서 사용할 수 있게 됨
        - 마지막으로 next가 호출되어 제어를 express 애플리케이션의 다음 미들웨어 함수나 라우트 핸들러로 전달
    - 현재 이렇게 구성을 해놓은 상태이며, 로그인 관련 router에서 jwt 내용을 추가하고 클라이언트 측에 연결해봐야 정확한 테스트를 해볼 수 있다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/67c6467d38cb4651ccced6f2a6e3a495625b33d5)

  <br />

  - 로그인 라우터에 JWT 내용 추가
    - 나중에 테스트할 때 어떤 내용이 나오는지 확인할 수 있도록 jwt-auth.js 파일에 미리 console.log를 추가
    - user-router.js에서 jwt 라이브러리를 추가하고, 환경변수도 가져와야 하기 때문에 dotenv 라이브러리도 추가
    - router.use를 추가해서, `/login`에서만 jwt-auth의 내용이 적용되도록 구성
    - tokenKey도 환경변수로 가져온다.
    - jwt.sign을 추가해서 JWT를 생성
      - 여기서 sign은 JWT를 생성하는데 사용되는 함수의 이름으로 `jsonwebtoken` 라이브러리에서 sign 함수를 사용해서 JWT를 생성할 수 있다.
      - sign 함수의 이름은 라이브러리에서 정의한 함수명으로 변경이 불가능하고, 함수명을 따라야 정상적으로 사용할 수 있다.
      - jwt.sign 내용 구성
        - JWT 페이로드에는 토큰에 담기 원하는 정보가 들어간다.
          - 여기서는 사용자의 ID와 이메일이 포함된 객체가 페이로드로 사용된다.
        - 토큰을 서명하는데 사용되는 비밀키도 들어간다.
        - 토큰의 만료 시간을 설정한다.
          - 토큰이 1시간 후에 만료되도록 설정되어 있으며, 토큰이 만료되면 클라이언트는 새로운 토큰을 요청해야 함
    - 이렇게 로그인 라우터에도 jwt 내용을 추가했으며, 이 내용을 클라이언트 측에서 불러와서 로그인 시 토큰과 관련된 데이터를 클라이언트 측에서 저장하고 확인하는 작업이 이루어지도록 내용을 추가해야 한다.
    - [코드 내용](https://github.com/jeongsangtae/mini-community-platform/commit/b13b1598e04d50d7f3a0f86776ac405fe714db38)

  <br />

  - JWT 내용 구성에 대한 정리
    - JWT 전체 내용이 아닌, 내가 여기서 구성한 내용을 정리
    - 따로 미들웨어 파일에서 header를 설정해서 `"Authorization"`로 지정
      - jwt.verify는 세 가지 주요 매개변수가 필요
      - 확인할 토큰 (token)
        - 검증할 JWT가 필요
        - 일반적으로 HTTP 요청의 헤더에서 `"Authorization"` 헤더로 전송된 토큰을 추출하여 사용
      - 비밀 키
        - 토큰을 서명할 때 사용된 비밀 키가 필요
        - 이 키는 서버에서만 알고 있어야 하며, 클라이언트에서는 절대 알 수 없어야 한다.
      - Callback Function (콜백 함수)
        - 토큰 검증이 완료된 후에 실행될 콜백 함수가 필요
        - 함수는 두 개의 매개변수를 받는다.
          - err와 decoded
          - err와 decoded는 원하는 이름으로 지정 가능함
          - decoded는 토큰이 검증되고 해독된 결과를 나타내며, 보통 `Payload`의 내용이 된다.
            - 이 정보를 활용하여 서버 측에서 추가적인 작업을 수행할 수 있다.
            - jwt.sign의 payload 데이터가 들어온다.
    - jwt를 사용하는 곳에서는 jwt.sign을 구성하는데 여기에서 sign 이라는 함수명은 변경이 불가능하다.
      - jwt.sign에는 세 가지 주요 매개변수가 필요
      - Payload(페이로드)
        - 토큰에 포하될 클레임 정보가 담긴 객체
        - 클레임은 토큰에 담기 원하는 정보를 나타내며, 사용자 식별자, 권한, 추가적인 메타 데이터 등이 여기에 포함됨
        - 예로, 사용자 ID와 이메일을 포함하는 페이로드 같이 구성
      - 비밀 키
        - verify처럼 토큰을 서명하는데 사용되는 비밀 키
        - 서버에서 비밀 키를 사용해서 토큰의 서명을 생성하고, 클라이언트에서는 이 비밀 키를 사용해 서버에서 받은 토큰을 검증함
      - Option(옵션)
        - 토큰의 추가적인 옵션을 설정하는 객체
        - 주로 토큰의 만료 시간을 설정하거나 다른 알고리즘을 사용하려는 경우에 이 옵션을 활용
        - 예로, 토큰의 만료 시간을 1시간으로 설정을 한다던지 그런 방식으로 사용

<br />

- 추가 및 해결 해야 할 내용
  - 회원가입 form에서 잘못된 입력을 제출 했을 때, session에 데이터가 저장되는데, 기존의 session 데이터에서 업데이트되는 방식이 아닌 매번 제출할 때마다 새로운 session이 추가되고 있기 때문에 백엔드 코드에서 수정이 필요하다.
    - 계속 원인을 찾아보려고 이것저것 시도해보았지만 아직 어떤 코드가 정확히 원인인지 찾지 못해서 하나씩 천천히 테스트가 필요함
    - 일단 이걸 테스트 해보기전에 먼저 정상적으로 세션 만료가 되는지 확인해보았는데 정상적으로 세션 만료가 되기 때문에, 로그인을 먼저 구성해보고 정상적으로 로그인이 되는지 확인을 해보고 안된다면, session에 저장되는 부분을 다시 확인해봐야 할 것 같다는 생각
  - 로그인이 되는지 확인하고, 로그인이 되었다면 메인헤더가 변경되도록 구성해야 함
    - `req.session.isAuthenticated`를 프론트엔드에 전달해서, useState를 이용해 메인헤더가 변경되도록 해주면 될 것 같음 (완료)
    - 현재 결과로 따지면 로그인도 되고, 메인헤더가 변경되긴 하지만 순환 참조 오류가 있어서 추가 작업이 필요함 (완료)
    - 로그인 시 `isAuthenticated` 정보가 MainHeader 컴포넌트로 넘어가서 useState에 true로 값이 저장되며, 해당 값을 사용해서 조건부 렌더링이 작동하도록 구성해서 순환 참조 오류없이 작동하도록 구성 (완료)
  - 로그인 후에, 새로고침시 로그아웃 되어버리는 상황도 수정을 해야 함
    - 순환 참조 오류는 해결했지만, 로그인하고 새로고침하면 다시 메인헤더가 로그인하지 않은 상태로 돌아오기 때문에 수정이 필요하다.
    - JWT를 사용해서 클라이언트 측에서 state를 유지하게 해줘야 한다.
      - 사용자의 인증 정보를 클라이언트에 저장해서 지속적으로 유지해야 함
  - 로그아웃 기능도 추가해야 함
    - 로그인이 성공하면 메인헤더가 변경되고 로그아웃 버튼이 추가되며, 로그아웃 버튼 클릭 시 메인 헤더의 내용이 초기 상태로 돌아오도록 구성을 해줘야 함

# 오늘 느낀 점

- JWT를 처음 사용해보기 때문에 어떤 식으로 구성을 해야 하는지 많이 헷갈려서 좀 찾아보고 코드를 살펴보았는데 이제 조금 알 것 같다는 생각이 든다. 처음에는 어떻게 구성해야 하고 저 내용이 왜 들어가는지 이해를 못했는데, 정리를 하면서 확실하게 이해가 된 것 같다. 지금 사용해본 내용만 정리를 해보았는데, 아마도 더 추가적인 내용이 있겠지만 현재는 필요한 내용만 이해하고 갈 생각이며, JWT에 대해 내용이 더 추가된다면 그 때 추가로 정리할 생각이다.

- 현재 서버에서 세션도 사용하고, JWT도 사용하고 있는 상황인데 이걸 굳이 두 가지 모두 사용해서 구성해야 하는지 헷갈려서 ChatGPT에게 좀 물어보았는데, 분명 이전에는 서버에서 세션을 사용해서 처리하고, 클라이언트 측에서는 JWT를 사용하는 것이 일반적인 구성이라고 했지만, 또 다시 물어보았는데 전혀 대답이 달랐다. 세션과 JWT를 동시에 사용하고 있는데, 특별한 이유가 없다면 조금 복잡할 수 있다고 하며 일반적으로 둘 중 하나를 선택해 사용하는 것이 권장되는 방식이라고 해서 머릿속이 복잡해졌다. 결과적으로 서버 측에서는 세션을 다루는 라이브러리를 사용해서 세션을 처리하는 것이 일반적이고, 클라이언트 측에서는 보통 JWT를 사용해 사용자의 인증 정보를 안전하게 저장하고 전송하는 것이 일반적이라고 한다. 서버는 세션을 통해 사용자의 상태를 유지, 그리고 클라이언트는 JWT를 사용해 로그인 상태를 유지하는 방식으로 구성한다고 알려주었다. 대부분 세션과 JWT 중 하나를 선택해 사용하는 것이 더 간단하고 일반적이라고 하며, 하나만 사용할 경우 코드를 이해하고 유지보수하기가 더 쉽다고 하기 때문에 JWT만 사용하는 방향으로 생각중이다. 굳이 두 기술을 함께 사용할 필요성을 못 느끼는 중인데, 무엇보다 세션만 사용해서는 사용자의 로그인 상태를 유지할 수 없었기 때문에 JWT를 사용해서 로그인 상태를 유지할 수 있도록 해줄 생각이다.

<br />

# 내일 할 일

- React 공부 및 React 프로젝트 조금씩 진행하기

<br />

# 앞으로 해야 할 일

- React, NextJS 공부

- React 프로젝트 제작
